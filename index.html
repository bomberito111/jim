<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>HYPER â€” Jaime</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --ac: #4361EE;        /* accent */
  --ac2: 67,97,238;     /* accent rgb */
  --bg0: #0A0A0F;
  --bg1: #111118;
  --bg2: #18181F;
  --bg3: #20202A;
  --bg4: #2A2A36;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.13);
  --text: #EEEEF5;
  --text2: #8080A0;
  --text3: #404060;
  --amber: #F4A023;
  --red: #EF4444;
  --success: #10B981;
  --purple: #8B5CF6;
  --mono: 'JetBrains Mono', monospace;
  --body: 'Outfit', sans-serif;
  --hd: 'Barlow Condensed', sans-serif;
  --r: 14px;
  --rsm: 8px;
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg0);color:var(--text);font-family:var(--body);font-size:15px;overflow:hidden;overscroll-behavior:none}
body{display:flex;flex-direction:column}

::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
input[type=number]{-moz-appearance:textfield}
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{flex:1;display:flex;flex-direction:column;overflow:hidden}
#views{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.view{padding:16px 14px 24px;animation:vu .2s ease}
@keyframes vu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#nav{
  display:flex;align-items:stretch;
  height:60px;background:var(--bg1);
  border-top:1px solid var(--border);
  flex-shrink:0;position:relative;
  padding-bottom:env(safe-area-inset-bottom);
}
#nav::before{
  content:'';position:absolute;top:-1px;left:10%;right:10%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(var(--ac2),.5),transparent);
}
.ni{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;background:none;border:none;color:var(--text3);cursor:pointer;
  font-family:var(--body);font-size:8.5px;font-weight:700;letter-spacing:.8px;
  text-transform:uppercase;transition:color .2s;position:relative;padding:0;
}
.ni.on{color:var(--ac)}
.ni.on::before{
  content:'';position:absolute;top:0;left:25%;right:25%;height:2px;
  background:var(--ac);border-radius:0 0 3px 3px;
}
.ni svg{width:21px;height:21px;stroke-width:1.8}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TYPOGRAPHY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hd{font-family:var(--hd);letter-spacing:.5px}
.mono{font-family:var(--mono)}
h1.title{font-family:var(--hd);font-size:32px;font-weight:800;letter-spacing:1px;line-height:1}
.sub{font-size:12px;color:var(--text2);margin-top:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:10px}
.card-glow{border-color:rgba(var(--ac2),.25);box-shadow:0 0 20px rgba(var(--ac2),.06)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:13px 20px;border-radius:var(--r);border:none;cursor:pointer;
  font-family:var(--body);font-weight:700;font-size:14px;letter-spacing:.2px;
  transition:all .15s;-webkit-appearance:none;
}
.btn-w{width:100%}
.bp{background:var(--ac);color:#fff;box-shadow:0 4px 18px rgba(var(--ac2),.35)}
.bp:active{transform:scale(.97);box-shadow:none}
.bg{background:var(--bg3);color:var(--text);border:1px solid var(--border2)}
.bg:active{background:var(--bg4)}
.bsm{padding:9px 15px;font-size:13px;border-radius:var(--rsm)}
.bdng{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inp{
  background:var(--bg3);border:1px solid var(--border2);color:var(--text);
  padding:11px 13px;border-radius:var(--rsm);font-family:var(--body);
  font-size:15px;outline:none;width:100%;transition:border-color .15s;
}
.inp:focus{border-color:var(--ac)}
.inp::placeholder{color:var(--text3)}
.lbl{font-size:10px;color:var(--text2);font-weight:700;letter-spacing:.7px;text-transform:uppercase;margin-bottom:5px;display:block}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tag{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700}
.tac{background:rgba(var(--ac2),.15);color:var(--ac)}
.tam{background:rgba(244,160,35,.15);color:var(--amber)}
.trd{background:rgba(239,68,68,.15);color:var(--red)}
.tgr{background:rgba(16,185,129,.15);color:var(--success)}
.tmu{background:var(--bg4);color:var(--text2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px}
.hero-left h2{font-size:13px;color:var(--text2);margin-bottom:2px}
.hero-left h1{font-family:var(--hd);font-size:40px;font-weight:900;letter-spacing:1px;line-height:1}
.streak-box{background:linear-gradient(135deg,rgba(244,160,35,.18),rgba(244,160,35,.05));border:1px solid rgba(244,160,35,.3);border-radius:var(--r);padding:10px 13px;text-align:center;min-width:66px}
.streak-n{font-family:var(--mono);font-size:28px;font-weight:700;color:var(--amber);display:block}
.streak-l{font-size:9px;color:var(--amber);letter-spacing:.8px;text-transform:uppercase;opacity:.8}

/* week strip */
.week-strip{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:14px}
.day-cell{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 2px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--rsm)}
.day-cell.today{border-color:var(--ac);background:rgba(var(--ac2),.08)}
.day-cell.trained{background:rgba(var(--ac2),.12);border-color:rgba(var(--ac2),.3)}
.day-ltr{font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.day-cell.today .day-ltr{color:var(--ac)}
.day-dot{width:7px;height:7px;border-radius:50%;background:var(--bg4)}
.day-cell.trained .day-dot{background:var(--ac);box-shadow:0 0 6px rgba(var(--ac2),.5)}
.day-cell.today.trained .day-dot{background:var(--amber)}

/* quick stats */
.qstats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.qstat{background:var(--bg2);border:1px solid var(--border);border-radius:var(--rsm);padding:11px 8px;text-align:center}
.qsval{font-family:var(--mono);font-size:20px;font-weight:700;display:block}
.qslbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;margin-top:2px}

/* prog alert */
.palert{
  background:linear-gradient(135deg,rgba(var(--ac2),.12),rgba(var(--ac2),.04));
  border:1px solid rgba(var(--ac2),.3);border-radius:var(--r);
  padding:11px 13px;margin-bottom:9px;display:flex;align-items:center;gap:10px;
}
.palert-ic{font-size:20px;flex-shrink:0}
.palert-txt{font-size:13px;line-height:1.5}
.palert-txt strong{color:var(--ac)}

/* today workout card */
.today-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:10px}
.today-hd{
  padding:13px 14px;border-bottom:1px solid var(--border);
  background:linear-gradient(135deg,rgba(var(--ac2),.1),transparent);
  display:flex;align-items:center;justify-content:space-between;
}
.today-name{font-family:var(--hd);font-size:22px;font-weight:800;letter-spacing:.5px}
.today-meta{font-size:12px;color:var(--text2);margin-top:2px}
.ex-prev{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ex-prev:last-child{border-bottom:none}
.ex-prev-name{font-size:13px;font-weight:600}
.ex-prev-meta{font-size:11px;color:var(--text2);margin-top:1px}
.ex-prev-last{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--ac)}

/* day selector */
.day-sel{display:flex;gap:6px;overflow-x:auto;padding:2px 0 8px;margin-bottom:4px;scrollbar-width:none}
.day-sel::-webkit-scrollbar{display:none}
.day-btn{flex-shrink:0;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--rsm);padding:8px 14px;cursor:pointer;font-family:var(--body);font-size:12px;font-weight:600;color:var(--text2);white-space:nowrap;transition:all .15s}
.day-btn.sel{background:rgba(var(--ac2),.15);border-color:var(--ac);color:var(--ac)}
.day-btn.today-btn{position:relative}
.day-btn.today-btn::after{content:'HOY';position:absolute;top:-6px;right:2px;font-size:7px;font-weight:800;color:var(--ac);letter-spacing:.5px}

/* session preview */
.sess-item{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.sess-left h4{font-weight:600;font-size:14px;margin-bottom:2px}
.sess-left p{font-size:11px;color:var(--text2)}
.sess-right{text-align:right}
.sess-vol{font-family:var(--mono);font-size:16px;font-weight:700;color:var(--ac)}
.sess-dur{font-size:10px;color:var(--text3)}

/* rest card */
.rest-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:40px 20px;text-align:center;margin-bottom:10px}
.rest-emoji{font-size:52px;margin-bottom:12px}
.rest-title{font-family:var(--hd);font-size:26px;font-weight:800;letter-spacing:.5px;margin-bottom:8px}
.rest-desc{color:var(--text2);font-size:13px;line-height:1.6}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORKOUT PLAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wp-sticky{position:sticky;top:0;z-index:20;background:var(--bg1);border-bottom:1px solid var(--border);padding:12px 14px 10px}
.wp-row1{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px}
.wp-title{font-family:var(--hd);font-size:19px;font-weight:800;letter-spacing:.3px}
.wp-timer-pill{font-family:var(--mono);font-size:13px;font-weight:600;background:var(--bg3);border:1px solid var(--border2);border-radius:20px;padding:4px 11px}
.wp-meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px}
.wp-sets-done{font-size:12px;color:var(--text2)}
.wp-pct{font-size:12px;font-weight:700;color:var(--ac)}
.wp-pbar{height:3px;background:var(--bg4);border-radius:3px;overflow:hidden}
.wp-pfill{height:100%;background:linear-gradient(90deg,var(--ac),rgba(var(--ac2),.5));border-radius:3px;transition:width .4s ease}

/* exercise block */
.exb{background:var(--bg0);border-bottom:1px solid var(--border);padding:15px 14px}
.exb-name{font-family:var(--hd);font-size:19px;font-weight:800;letter-spacing:.3px;margin-bottom:2px}
.exb-meta{font-size:12px;color:var(--text2);margin-bottom:10px}
.ex-note-box{background:rgba(244,160,35,.07);border-left:2px solid var(--amber);border-radius:0 var(--rsm) var(--rsm) 0;padding:7px 10px;margin-bottom:10px;font-size:12px;color:var(--amber);line-height:1.5}
.prog-box{
  background:linear-gradient(135deg,rgba(var(--ac2),.13),rgba(var(--ac2),.03));
  border:1px solid rgba(var(--ac2),.3);border-radius:var(--rsm);
  padding:9px 11px;margin-bottom:10px;display:flex;align-items:center;gap:8px;font-size:13px;
}
.prog-box strong{color:var(--ac)}

/* sets table */
.sets-hdr{display:grid;grid-template-columns:22px 1fr 1fr 1fr 40px;gap:7px;margin-bottom:7px;padding:0 1px}
.sets-hdr span{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:700;text-align:center}
.sets-hdr span:first-child{text-align:left}
.set-r{display:grid;grid-template-columns:22px 1fr 1fr 1fr 40px;gap:7px;align-items:center;margin-bottom:8px;transition:opacity .2s}
.set-r.set-done{opacity:.4}
.set-num{font-family:var(--mono);font-size:12px;color:var(--text3);text-align:center;font-weight:600}
.set-field{display:flex;flex-direction:column;align-items:center;gap:1px}
.set-inp{
  background:var(--bg3);border:1px solid var(--border2);color:var(--text);
  text-align:center;padding:9px 3px;border-radius:var(--rsm);
  font-family:var(--mono);font-size:16px;font-weight:700;outline:none;width:100%;
  -webkit-appearance:none;transition:border-color .15s;
}
.set-inp:focus{border-color:var(--ac);background:var(--bg4)}
.set-inp::placeholder{color:var(--text3);font-size:12px}
.set-hint{font-family:var(--mono);font-size:9px;color:var(--text3)}
.set-chk{
  width:38px;height:38px;border-radius:50%;border:2px solid var(--border2);
  background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;
  color:var(--text3);transition:all .18s;-webkit-appearance:none;
}
.set-chk.ck{background:var(--ac);border-color:var(--ac);color:#fff;box-shadow:0 2px 12px rgba(var(--ac2),.4)}

.partial-tog{display:flex;align-items:center;gap:7px;margin-top:8px;font-size:12px;color:var(--text2);cursor:pointer}
.partial-tog input[type=checkbox]{accent-color:var(--ac);width:15px;height:15px}
.add-set{width:100%;padding:9px;margin-top:7px;background:none;border:1px dashed var(--border2);border-radius:var(--rsm);color:var(--text3);font-family:var(--body);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px}
.add-set:hover{border-color:var(--ac);color:var(--ac)}

.fin-zone{padding:18px 14px 32px;background:var(--bg0)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLOATING REST TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#rtimer{
  position:fixed;bottom:68px;left:12px;right:12px;
  background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);
  padding:11px 15px;display:flex;align-items:center;justify-content:space-between;
  z-index:90;box-shadow:0 8px 32px rgba(0,0,0,.7);
  transition:all .3s cubic-bezier(.34,1.56,.64,1);
}
#rtimer.hidden{opacity:0;transform:translateY(16px) scale(.96);pointer-events:none}
.rt-left{display:flex;flex-direction:column;gap:1px}
.rt-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;font-weight:700}
.rt-cnt{font-family:var(--mono);font-size:32px;font-weight:700;line-height:1}
.rt-cnt.urg{color:var(--red);animation:pulse 1s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.rt-btns{display:flex;gap:6px}
.rt-btn{background:var(--bg4);border:1px solid var(--border2);color:var(--text2);border-radius:var(--rsm);padding:8px 11px;cursor:pointer;font-size:12px;font-weight:700;font-family:var(--body);transition:all .12s}
.rt-skip{background:var(--ac);color:#fff;border-color:var(--ac)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{display:flex;background:var(--bg2);border-radius:var(--rsm);padding:3px;gap:2px;margin-bottom:14px}
.tab{flex:1;padding:9px 4px;border:none;background:none;color:var(--text2);border-radius:6px;cursor:pointer;font-family:var(--body);font-size:12px;font-weight:700;transition:all .2s}
.tab.on{background:var(--bg4);color:var(--text)}

.chart-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:10px}
.chart-title{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
.chart-cnt{height:155px;position:relative}

.hist-item{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:13px;margin-bottom:8px}
.hist-date{font-size:10px;color:var(--text3);margin-bottom:3px}
.hist-name{font-weight:700;font-size:15px;margin-bottom:7px}
.hist-meta{display:flex;gap:12px;font-family:var(--mono);font-size:11px;color:var(--text2)}

.pr-item{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:13px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.pr-crown{font-size:9px;font-weight:800;letter-spacing:.5px;padding:2px 7px;border-radius:4px;background:linear-gradient(135deg,var(--amber),#FF7700);color:#000;text-transform:uppercase;display:inline-block;margin-bottom:3px}
.pr-w{font-family:var(--mono);font-size:26px;font-weight:700;color:var(--amber)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BODY VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.body-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px}
.body-field{display:flex;flex-direction:column;gap:4px}
.body-inp{background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:11px;border-radius:var(--rsm);font-family:var(--mono);font-size:20px;font-weight:700;outline:none;width:100%;text-align:center;-webkit-appearance:none}
.body-inp:focus{border-color:var(--ac)}
.meas-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.meas-row:last-child{border-bottom:none}
.meas-lbl{font-size:13px;font-weight:500}
.meas-val{font-family:var(--mono);font-size:15px;font-weight:700;color:var(--ac)}
.delta-pos{color:var(--success);font-size:10px}
.delta-neg{color:var(--red);font-size:10px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sett-row{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.sett-row h4{font-size:14px;font-weight:600;margin-bottom:2px}
.sett-row p{font-size:11px;color:var(--text2)}
.sett-arrow{color:var(--text3);font-size:16px}

.swatches{display:flex;flex-wrap:wrap;gap:7px;margin:10px 0 4px}
.sw{width:34px;height:34px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;position:relative}
.sw.on{border-color:#fff;transform:scale(1.1)}
.sw.on::after{content:'âœ“';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:700}

.sync-bar{display:flex;align-items:center;gap:8px;padding:9px 12px;background:var(--bg3);border-radius:var(--rsm);margin-bottom:12px;font-size:13px}
.sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sd-on{background:#10B981;box-shadow:0 0 7px #10B981}
.sd-loc{background:var(--amber)}
.sd-off{background:var(--text3)}

.user-code{font-family:var(--mono);font-size:24px;font-weight:700;text-align:center;letter-spacing:4px;color:var(--ac);background:rgba(var(--ac2),.08);border:1px solid rgba(var(--ac2),.2);border-radius:var(--r);padding:14px;margin:8px 0}

/* 1RM calc */
.rmcalc-result{font-family:var(--mono);font-size:36px;font-weight:700;color:var(--ac);text-align:center;padding:12px;background:rgba(var(--ac2),.08);border-radius:var(--rsm);margin-top:8px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CELEBRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#cel{
  position:fixed;inset:0;background:rgba(10,10,15,.97);z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 20px;text-align:center;opacity:0;transition:opacity .35s;pointer-events:none;
}
#cel.show{opacity:1;pointer-events:all}
.cel-title{font-family:var(--hd);font-size:52px;font-weight:900;letter-spacing:2px;color:var(--ac);line-height:1;margin-bottom:4px}
.cel-sub{font-size:14px;color:var(--text2);margin-bottom:20px}
.cel-gif{width:170px;height:170px;object-fit:cover;border-radius:var(--r);margin-bottom:20px;border:2px solid var(--ac);box-shadow:0 0 30px rgba(var(--ac2),.3)}
.cel-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;width:100%;max-width:320px;margin-bottom:24px}
.cel-stat{background:var(--bg3);border-radius:var(--rsm);padding:12px}
.cel-val{font-family:var(--mono);font-size:20px;font-weight:700;color:var(--ac);display:block}
.cel-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM SHEET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:150;display:flex;align-items:flex-end;justify-content:center;opacity:0;transition:opacity .2s;pointer-events:none}
.overlay.open{opacity:1;pointer-events:all}
.sheet{background:var(--bg2);border-radius:20px 20px 0 0;padding:20px 18px 40px;width:100%;border-top:1px solid var(--border);transform:translateY(20px);transition:transform .25s;max-height:88vh;overflow-y:auto}
.overlay.open .sheet{transform:translateY(0)}
.sheet-handle{width:40px;height:4px;background:var(--bg4);border-radius:4px;margin:0 auto 18px}
.sheet-title{font-family:var(--hd);font-size:22px;font-weight:800;letter-spacing:.3px;margin-bottom:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{
  position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);
  background:var(--bg3);border:1px solid var(--border2);color:var(--text);
  padding:10px 18px;border-radius:40px;font-size:13px;font-weight:600;
  z-index:300;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 4px 18px rgba(0,0,0,.5);
}
#toast.show{transform:translateX(-50%) translateY(0)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty{text-align:center;padding:44px 20px}
.empty-ico{font-size:44px;margin-bottom:12px}
.empty h3{font-family:var(--hd);font-size:22px;font-weight:800;letter-spacing:.5px;margin-bottom:7px}
.empty p{color:var(--text2);font-size:13px;line-height:1.6}

/* Firebase config */
.fb-inp{width:100%;background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:10px 11px;border-radius:var(--rsm);font-family:var(--mono);font-size:12px;outline:none;margin-bottom:7px}
.fb-inp::placeholder{color:var(--text3)}
.fb-inp:focus{border-color:var(--ac)}
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast"></div>

<!-- CELEBRATION -->
<div id="cel">
  <div class="cel-title" id="cel-title">ğŸ† LISTO!</div>
  <div class="cel-sub" id="cel-sub">AsÃ­ se construye mÃºsculo ğŸ’ª</div>
  <img id="cel-gif" class="cel-gif" src="" alt="">
  <div class="cel-stats" id="cel-stats"></div>
  <button class="btn bp btn-w" style="max-width:300px" onclick="closeCel()">Ver resumen â†’</button>
</div>

<!-- REST TIMER -->
<div id="rtimer" class="hidden">
  <div class="rt-left">
    <span class="rt-lbl">â± Descanso</span>
    <span class="rt-cnt" id="rtdisp">2:00</span>
  </div>
  <div class="rt-btns">
    <button class="rt-btn" onclick="adjRT(-30)">âˆ’30s</button>
    <button class="rt-btn" onclick="adjRT(30)">+30s</button>
    <button class="rt-btn rt-skip" onclick="skipRT()">âœ“ Skip</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div id="views">
    <div id="v-home" class="view"></div>
    <div id="v-workout" style="display:none"></div>
    <div id="v-progress" class="view" style="display:none"></div>
    <div id="v-body" class="view" style="display:none"></div>
    <div id="v-settings" class="view" style="display:none"></div>
  </div>
  <nav id="nav">
    <button class="ni on" id="ni-home" onclick="nav('home')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Inicio
    </button>
    <button class="ni" id="ni-workout" onclick="nav('workout')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
      Workout
    </button>
    <button class="ni" id="ni-progress" onclick="nav('progress')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Progreso
    </button>
    <button class="ni" id="ni-body" onclick="nav('body')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="5" r="3"/><path d="M12 8v5M9 19l3-6 3 6M7 19h10M9 12H7M15 12h2"/></svg>
      Cuerpo
    </button>
    <button class="ni" id="ni-settings" onclick="nav('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Ajustes
    </button>
  </nav>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RUTINA COMPLETA DE JAIME (5 DÃAS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ROUTINE = {
  1:{ // LUNES
    name:'ESPALDA & BÃCEPS', emoji:'ğŸ’ª', color:'#4361EE',
    exercises:[
      {id:'e01',g:'Espalda',name:'JalÃ³n unilateral desde arriba',sets:4,rMin:8,rMax:12,rest:120,type:'iso',
       notes:'ConexiÃ³n mente-mÃºsculo, estiramiento completo. Codo pegado al cuerpo en la bajada.',
       video:'https://www.youtube.com/results?search_query=cable+pulldown+one+arm+technique'},
      {id:'e02',g:'Espalda',name:'Remo a un brazo con mancuerna',sets:4,rMin:8,rMax:12,rest:120,type:'comp',
       notes:'Foco en contraer dorsal, NO tirar con bÃ­ceps. Apoya rodilla en banco.',
       video:'https://www.youtube.com/results?search_query=dumbbell+one+arm+row+form'},
      {id:'e03',g:'Espalda',name:'JalÃ³n mÃ¡quina agarre neutro',sets:3,rMin:10,rMax:12,rest:90,type:'iso',
       notes:'Mantiene tensiÃ³n constante. Saca pecho al bajar la barra.',
       video:'https://www.youtube.com/results?search_query=neutral+grip+lat+pulldown'},
      {id:'e04',g:'Espalda',name:'Remo con barra o polea baja',sets:3,rMin:8,rMax:12,rest:120,type:'comp',
       notes:'Movimiento compuesto para densidad. Tira hacia el abdomen bajo.',
       video:'https://www.youtube.com/results?search_query=barbell+row+form+tutorial'},
      {id:'e05',g:'BÃ­ceps',name:'Curl barra (recta o W)',sets:3,rMin:8,rMax:12,rest:90,type:'comp',
       notes:'Movimiento base. Carga progresiva cada semana. No balancees el torso.',
       video:'https://www.youtube.com/results?search_query=barbell+curl+proper+form'},
      {id:'e06',g:'BÃ­ceps',name:'Curl mancuernas banco inclinado',sets:3,rMin:10,rMax:12,rest:90,type:'iso',
       notes:'Estiramiento mÃ¡ximo bÃ­ceps largo. Codos fijos atrÃ¡s del cuerpo.',
       video:'https://www.youtube.com/results?search_query=incline+dumbbell+curl+technique'},
      {id:'e07',g:'Pantorrillas',name:'ElevaciÃ³n de talÃ³n de pie',sets:3,rMin:12,rMax:15,rest:60,type:'iso',
       notes:'Foco en gastrocnemio (gemelos). Pausa 1s arriba y 1s abajo.',
       video:'https://www.youtube.com/results?search_query=standing+calf+raise+technique'},
    ]
  },
  2:{ // MARTES
    name:'PECHO & TRÃCEPS', emoji:'ğŸ”¥', color:'#EF4444',
    exercises:[
      {id:'e08',g:'Pecho',name:'Press plano con barra',sets:4,rMin:6,rMax:10,rest:180,type:'comp',
       notes:'ğŸ”¥ MOVIMIENTO REY â€” ProgresiÃ³n principal. ExcÃ©ntrica de 2-3s. Barra al esternÃ³n.',
       video:'https://www.youtube.com/results?search_query=bench+press+correct+form'},
      {id:'e09',g:'Pecho',name:'Press plano con mancuernas',sets:3,rMin:8,rMax:12,rest:150,type:'comp',
       notes:'Mayor rango de movimiento que la barra. Toca las mancuernas arriba.',
       video:'https://www.youtube.com/results?search_query=dumbbell+bench+press+form'},
      {id:'e10',g:'Pecho',name:'Press inclinado con barra',sets:3,rMin:8,rMax:12,rest:150,type:'comp',
       notes:'Ã‰nfasis pectoral superior. Banco a 30-45Â°. Mucho potencial de crecimiento.',
       video:'https://www.youtube.com/results?search_query=incline+barbell+press+technique'},
      {id:'e11',g:'Pecho',name:'Aperturas en polea (cruce)',sets:3,rMin:10,rMax:15,rest:90,type:'iso',
       notes:'TensiÃ³n constante durante todo el movimiento. Cruza manos al frente.',
       video:'https://www.youtube.com/results?search_query=cable+crossover+chest+fly'},
      {id:'e12',g:'TrÃ­ceps',name:'JalÃ³n trÃ­ceps en polea',sets:3,rMin:8,rMax:12,rest:90,type:'iso',
       notes:'Cabeza lateral y medial. Codos pegados al cuerpo, extensiÃ³n completa.',
       video:'https://www.youtube.com/results?search_query=cable+tricep+pushdown+form'},
      {id:'e13',g:'TrÃ­ceps',name:'Patada de trÃ­ceps en polea',sets:3,rMin:10,rMax:12,rest:90,type:'iso',
       notes:'ContracciÃ³n pico mÃ¡xima. Sin estrÃ©s en los codos. Pausa 1s extendido.',
       video:'https://www.youtube.com/results?search_query=cable+tricep+kickback+proper'},
    ]
  },
  3:{ // MIÃ‰RCOLES
    name:'PIERNAS', emoji:'ğŸ¦µ', color:'#10B981',
    exercises:[
      {id:'e14',g:'Piernas',name:'Sentadilla con barra',sets:4,rMin:6,rMax:10,rest:180,type:'comp',
       notes:'ğŸ”¥ REY del tren inferior. Baja a paralelo MÃNIMO. Rodillas siguen punta del pie.',
       video:'https://www.youtube.com/results?search_query=barbell+squat+proper+form+depth'},
      {id:'e15',g:'Piernas',name:'Prensa de piernas',sets:3,rMin:8,rMax:12,rest:150,type:'comp',
       notes:'Volumen sin fatiga de core. Pies ligeramente mÃ¡s abajo = mÃ¡s cuÃ¡driceps.',
       video:'https://www.youtube.com/results?search_query=leg+press+form+foot+placement'},
      {id:'e16',g:'Piernas',name:'Curl femoral (sentado o tumbado)',sets:3,rMin:8,rMax:12,rest:90,type:'iso',
       notes:'Aislamiento isquiotibiales. Lento en la bajada (2-3s excÃ©ntrica).',
       video:'https://www.youtube.com/results?search_query=leg+curl+seated+hamstring'},
      {id:'e17',g:'Piernas',name:'Peso muerto rumano',sets:3,rMin:8,rMax:10,rest:180,type:'comp',
       notes:'Cadena posterior completa. Espalda RECTA, empuja caderas hacia atrÃ¡s.',
       video:'https://www.youtube.com/results?search_query=romanian+deadlift+proper+form'},
      {id:'e18',g:'Pantorrillas',name:'ElevaciÃ³n de talÃ³n en prensa',sets:4,rMin:10,rMax:15,rest:60,type:'iso',
       notes:'Gastrocnemio con rodilla extendida. Rango completo, pausa abajo.',
       video:'https://www.youtube.com/results?search_query=leg+press+calf+raise+technique'},
      {id:'e19',g:'Pantorrillas',name:'ElevaciÃ³n de talÃ³n sentado',sets:3,rMin:12,rMax:20,rest:60,type:'iso',
       notes:'SÃ³leo (mÃºsculo profundo). Rodillas dobladas. Pausa 1s en estiramiento.',
       video:'https://www.youtube.com/results?search_query=seated+calf+raise+soleus'},
    ]
  },
  4:{ // JUEVES
    name:'BRAZOS (Ã‰NFASIS)', emoji:'ğŸ’ªğŸ‹ï¸', color:'#F4A023',
    exercises:[
      {id:'e20',g:'BÃ­ceps',name:'Curl con barra W (EZ)',sets:4,rMin:8,rMax:12,rest:120,type:'comp',
       notes:'ğŸ”¥ BASE para bÃ­ceps. Carga mÃ¡xima posible con buena tÃ©cnica. Sin balanceo.',
       video:'https://www.youtube.com/results?search_query=ez+bar+curl+bicep+form'},
      {id:'e21',g:'BÃ­ceps',name:'Curl martillo con mancuernas',sets:3,rMin:8,rMax:12,rest:90,type:'iso',
       notes:'Braquial + bÃ­ceps. Protege las muÃ±ecas. Grosor del brazo.',
       video:'https://www.youtube.com/results?search_query=hammer+curl+dumbbell+technique'},
      {id:'e22',g:'BÃ­ceps',name:'Curl en polea baja',sets:3,rMin:12,rMax:15,rest:60,type:'iso',
       notes:'Bombeo final, tensiÃ³n constante todo el movimiento. Sin descanso entre reps.',
       video:'https://www.youtube.com/results?search_query=cable+bicep+curl+low+pulley'},
      {id:'e23',g:'TrÃ­ceps',name:'Fondos en paralelas',sets:4,rMin:8,rMax:12,rest:120,type:'comp',
       notes:'ğŸ”¥ COMPUESTO para las 3 cabezas. Tronco erguido para mÃ¡s trÃ­ceps. Peso extra cuando puedas.',
       video:'https://www.youtube.com/results?search_query=parallel+bar+dips+triceps+upright'},
      {id:'e24',g:'TrÃ­ceps',name:'ExtensiÃ³n trÃ­ceps en polea',sets:3,rMin:8,rMax:12,rest:90,type:'iso',
       notes:'Cabeza lateral. Codos fijos arriba, extensiÃ³n completa.',
       video:'https://www.youtube.com/results?search_query=cable+tricep+overhead+extension'},
      {id:'e25',g:'TrÃ­ceps',name:'Patada trÃ­ceps en polea',sets:3,rMin:10,rMax:12,rest:90,type:'iso',
       notes:'ContracciÃ³n mÃ¡xima cabeza larga. MantÃ©n el brazo paralelo al suelo.',
       video:'https://www.youtube.com/results?search_query=cable+tricep+kickback+long+head'},
    ]
  },
  5:{ // VIERNES
    name:'HOMBROS & ESPALDA 2', emoji:'ğŸ”ï¸', color:'#8B5CF6',
    exercises:[
      {id:'e26',g:'Hombros',name:'Press hombro (mÃ¡quina o barra)',sets:4,rMin:8,rMax:12,rest:120,type:'comp',
       notes:'Deltoides anterior y medio. Empuje estable. No arqueÃ©s la espalda.',
       video:'https://www.youtube.com/results?search_query=shoulder+press+machine+overhead'},
      {id:'e27',g:'Hombros',name:'Elevaciones laterales',sets:3,rMin:10,rMax:15,rest:90,type:'iso',
       notes:'Aislamiento deltoides medio (ANCHO). Codos ligeramente doblados. Lento en la bajada.',
       video:'https://www.youtube.com/results?search_query=dumbbell+lateral+raise+proper+form'},
      {id:'e28',g:'Hombros',name:'Posterior en polea (face pull)',sets:3,rMin:10,rMax:15,rest:90,type:'iso',
       notes:'Deltoides posterior + trapecio. Esencial para salud del hombro y postura.',
       video:'https://www.youtube.com/results?search_query=cable+rear+delt+fly+face+pull'},
      {id:'e29',g:'Espalda',name:'JalÃ³n o remo ligero (tÃ©cnica)',sets:3,rMin:12,rMax:15,rest:90,type:'iso',
       notes:'Peso moderado 60-70%. ConexiÃ³n neural, no carga. Perfecciona el movimiento.',
       video:'https://www.youtube.com/results?search_query=cable+row+light+weight+mind+muscle'},
      {id:'e30',g:'Pantorrillas',name:'ElevaciÃ³n de talÃ³n de pie',sets:3,rMin:12,rMax:15,rest:60,type:'iso',
       notes:'Cierre semanal de pantorrillas. Estiramiento completo abajo, pausa arriba.',
       video:'https://www.youtube.com/results?search_query=standing+calf+raise+technique'},
    ]
  }
};
// Rest days
ROUTINE[0] = {name:'DESCANSO',emoji:'ğŸ˜´',rest:true,exercises:[]};
ROUTINE[6] = {name:'DESCANSO',emoji:'ğŸ˜´',rest:true,exercises:[]};

const ALL_EX = Object.values(ROUTINE).flatMap(d=>d.exercises||[]);
const GIFS = [
  'https://media.giphy.com/media/VbnUQpnihPSIgIXuZv/giphy.gif',
  'https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif',
  'https://media.giphy.com/media/3oriO6qJiXajN0TksU/giphy.gif',
  'https://media.giphy.com/media/Nm8ZPAGOwZUQM/giphy.gif',
  'https://media.giphy.com/media/ICOgUNjpvO0PC/giphy.gif',
];
const ACCENTS = [
  {name:'Azul ElÃ©ctrico',v:'#4361EE',r:'67,97,238'},
  {name:'Naranja',v:'#F97316',r:'249,115,22'},
  {name:'Cyan',v:'#06B6D4',r:'6,182,212'},
  {name:'Violeta',v:'#8B5CF6',r:'139,92,246'},
  {name:'Rosa',v:'#EC4899',r:'236,72,153'},
  {name:'Rojo',v:'#EF4444',r:'239,68,68'},
  {name:'Dorado',v:'#EAB308',r:'234,179,8'},
  {name:'Blanco',v:'#E2E8F0',r:'226,232,240'},
];
const DAY_NAMES = ['DOM','LUN','MAR','MIÃ‰','JUE','VIE','SÃB'];
const DAY_FULL  = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let db=null, useFB=false;
const UID = 'jaime_hyper_v3'; // Fixed â€” single user, always Jaime
let curView='home', curDay=new Date().getDay(), progTab='charts';
let activeW=null, rtSecs=0, rtIval=null, elIval=null;
let charts={};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSISTENT STORAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sget(key){
  if(useFB&&db){
    try{
      const d=await db.collection('hyper').doc(UID).collection('data').doc(key).get();
      if(d.exists){const v=d.data().v; localStorage.setItem('h3_'+key,JSON.stringify(v)); return v;}
    }catch(e){}
  }
  const r=localStorage.getItem('h3_'+key);
  return r?JSON.parse(r):null;
}
async function sset(key,val){
  localStorage.setItem('h3_'+key,JSON.stringify(val));
  if(useFB&&db){
    try{await db.collection('hyper').doc(UID).collection('data').doc(key).set({v:val});}catch(e){}
  }
}
async function spush(key,item){
  let a=await sget(key)||[];
  a.push(item);
  await sset(key,a);
  return a;
}
async function exhist(id){return await sget('ex_'+id)||[];}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT â€” no login, auto start
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function boot(){
  // Request persistent storage so browser never clears data
  if(navigator.storage&&navigator.storage.persist){
    const granted=await navigator.storage.persist();
    if(!granted) console.log('Storage persistence not granted');
  }
  // Load Firebase config if saved
  const fbcfg=localStorage.getItem('h3_fbcfg');
  if(fbcfg){
    try{
      const c=JSON.parse(fbcfg);
      if(!firebase.apps.length) firebase.initializeApp(c);
      else firebase.app();
      db=firebase.firestore();
      useFB=true;
    }catch(e){useFB=false;}
  }
  // Load accent
  const acc=await sget('accent');
  if(acc) applyAccent(acc.v,acc.r);
  // Render
  await renderHome();
}
boot();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function nav(v){
  ['home','workout','progress','body','settings'].forEach(n=>{
    const el=document.getElementById('v-'+n);
    const ni=document.getElementById('ni-'+n);
    if(el) el.style.display=n===v?(n==='workout'?'block':'block'):'none';
    if(ni) ni.classList.toggle('on',n===v);
  });
  document.getElementById('views').scrollTop=0;
  curView=v;
  if(v==='home') renderHome();
  else if(v==='workout') renderWorkout();
  else if(v==='progress') renderProgress();
  else if(v==='body') renderBody();
  else if(v==='settings') renderSettings();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderHome(){
  const el=document.getElementById('v-home');
  const today=new Date();
  const dow=today.getDay();
  const day=ROUTINE[curDay]||ROUTINE[dow];
  const sessions=await sget('sessions')||[];
  const body=(await sget('bodyLogs')||[]).slice(-1)[0]||{};

  // Streak â€” consecutive days trained
  const trainedDates=new Set(sessions.map(s=>s.date?.split('T')[0]));
  let streak=0;
  let check=new Date();
  for(let i=0;i<365;i++){
    const ds=check.toISOString().split('T')[0];
    if(trainedDates.has(ds)){streak++;check.setDate(check.getDate()-1);}
    else if(i===0){check.setDate(check.getDate()-1);}// today not trained yet
    else break;
  }

  // Week volume (last 7 days)
  const wkVol=sessions.filter(s=>Date.now()-new Date(s.date)<7*86400000).reduce((a,s)=>a+(s.vol||0),0);
  // Total sessions
  const totalSess=sessions.length;

  // Progression alerts for today
  const alerts=[];
  for(const ex of (day.exercises||[])){
    const h=await exhist(ex.id);
    if(h.length>=1){
      const last=h[h.length-1];
      const hitMax=last.sets?.some(s=>parseInt(s.r)>=ex.rMax);
      const goodRIR=last.sets?.some(s=>parseInt(s.rir||0)>1);
      if(hitMax&&goodRIR){
        const pw=Math.max(...(last.sets?.map(s=>parseFloat(s.w)||0)||[0]));
        alerts.push({name:ex.name,newW:pw+2.5});
      }
    }
  }

  // Build week calendar (Mon â†’ Sun)
  const weekHtml=DAY_NAMES.map((d,i)=>{
    const diff=i-dow; // how many days from today
    const dc=new Date(); dc.setDate(dc.getDate()+diff);
    const ds=dc.toISOString().split('T')[0];
    const isTrained=trainedDates.has(ds);
    const isToday=i===dow;
    return `<div class="day-cell ${isToday?'today':''} ${isTrained?'trained':''}">
      <span class="day-ltr">${d}</span>
      <div class="day-dot"></div>
    </div>`;
  }).join('');

  // Day selector
  const daySel=[1,2,3,4,5].map(d=>`
    <button class="day-btn ${d===curDay?'sel':''} ${d===dow?'today-btn':''}" onclick="selDay(${d})">
      ${ROUTINE[d].emoji} ${DAY_FULL[d]}
    </button>`).join('');

  // Exercise previews for selected day
  let exPreviews='';
  for(const ex of (day.exercises||[])){
    const h=await exhist(ex.id);
    const ls=h.slice(-1)[0]?.sets?.[0];
    exPreviews+=`<div class="ex-prev">
      <div>
        <div class="ex-prev-name">${ex.name}</div>
        <div class="ex-prev-meta">${ex.g} Â· ${ex.sets}Ã—${ex.rMin}-${ex.rMax} Â· ${ex.rest}s</div>
      </div>
      ${ls?`<div class="ex-prev-last">${ls.w}kgÃ—${ls.r}</div>`:'<span class="tag tmu" style="font-size:10px">NUEVO</span>'}
    </div>`;
  }

  // Recent sessions (last 4)
  const recent=sessions.slice(-4).reverse();

  el.innerHTML=`
<div class="hero">
  <div class="hero-left">
    <h2>${today.toLocaleDateString('es',{weekday:'long',day:'numeric',month:'long'})}</h2>
    <h1>JAIME</h1>
    ${day.rest?'<div style="margin-top:6px"><span class="tag tmu">ğŸ˜´ DÃ­a de descanso</span></div>':
    `<div style="margin-top:6px"><span class="tag tac">${day.emoji} ${day.name}</span></div>`}
  </div>
  <div class="streak-box">
    <span class="streak-n">${streak}</span>
    <span class="streak-l">ğŸ”¥ Racha</span>
  </div>
</div>

<div class="week-strip">${weekHtml}</div>

<div class="qstats">
  <div class="qstat">
    <span class="qsval">${body.w||'â€”'}</span>
    <span class="qslbl">Peso kg</span>
  </div>
  <div class="qstat">
    <span class="qsval">${Math.round(wkVol/100)/10||'0'}k</span>
    <span class="qslbl">Vol semana</span>
  </div>
  <div class="qstat">
    <span class="qsval">${totalSess}</span>
    <span class="qslbl">Sesiones</span>
  </div>
</div>

${alerts.map(a=>`<div class="palert">
  <div class="palert-ic">âš¡</div>
  <div class="palert-txt"><strong>+2.5kg en ${a.name}</strong><br>Ãšltima sesiÃ³n llegaste al tope â†’ Intenta <strong>${a.newW}kg</strong> hoy</div>
</div>`).join('')}

<div style="margin-bottom:8px">
  <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;font-weight:700;margin-bottom:7px">SELECCIONAR DÃA</div>
  <div class="day-sel">${daySel}</div>
</div>

${!day.rest?`
<div class="today-card">
  <div class="today-hd">
    <div>
      <div class="today-name">${day.emoji} ${day.name}</div>
      <div class="today-meta">${day.exercises.length} ejercicios Â· ${day.exercises.reduce((a,e)=>a+e.sets,0)} series totales</div>
    </div>
    <span class="tag tac">${DAY_FULL[curDay]===DAY_FULL[dow]?'HOY':'Otro dÃ­a'}</span>
  </div>
  ${exPreviews}
  <div style="padding:13px 14px">
    <button class="btn bp btn-w" onclick="startW(${curDay})">â–¶ INICIAR ENTRENAMIENTO</button>
  </div>
</div>`:
`<div class="rest-card">
  <div class="rest-emoji">ğŸ˜´</div>
  <div class="rest-title">DÃA DE DESCANSO</div>
  <div class="rest-desc">Hoy te toca recuperar.<br>Duerme 7-8h y consume 1.6-2.2g proteÃ­na/kg.</div>
</div>`}

${recent.length?`
<div style="margin-top:4px">
  <div style="font-family:var(--hd);font-size:18px;font-weight:800;letter-spacing:.5px;margin-bottom:10px;color:var(--text2)">ÃšLTIMAS SESIONES</div>
  ${recent.map(s=>`<div class="sess-item">
    <div class="sess-left">
      <h4>${s.rn}</h4>
      <p>${new Date(s.date).toLocaleDateString('es',{weekday:'short',day:'numeric',month:'short'})} Â· ${s.sc||0} series</p>
    </div>
    <div class="sess-right">
      <div class="sess-vol">${Math.round((s.vol||0)/100)/10}k kg</div>
      <div class="sess-dur">${fmtDur(s.dur)}</div>
    </div>
  </div>`).join('')}
</div>`:''}`;
}

function selDay(d){
  curDay=d;
  renderHome();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORKOUT PLAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startW(dow){
  const day=ROUTINE[dow];
  const exercises=[];
  for(const ex of day.exercises){
    const h=await exhist(ex.id);
    const last=h.slice(-1)[0];
    // Check progression
    let suggest=null;
    if(last){
      const hitMax=last.sets?.some(s=>parseInt(s.r)>=ex.rMax);
      const goodRIR=last.sets?.some(s=>parseInt(s.rir||0)>1);
      if(hitMax&&goodRIR){
        const pw=Math.max(...(last.sets?.map(s=>parseFloat(s.w)||0)||[0]));
        suggest=Math.round((pw+2.5)*4)/4;
      }
    }
    exercises.push({
      ...ex, last, suggest, partial:false,
      sets:Array.from({length:ex.sets},(_,i)=>({n:i+1,w:'',r:'',rir:'',done:false}))
    });
  }
  activeW={dow,rn:day.name,emoji:day.emoji,start:Date.now(),exercises};
  nav('workout');
}

function renderWorkout(){
  const el=document.getElementById('v-workout');
  if(!activeW){
    el.innerHTML=`<div class="view"><div class="empty"><div class="empty-ico">ğŸ‹ï¸</div><h3>SIN WORKOUT ACTIVO</h3><p>Ve al inicio y pulsa "Iniciar Entrenamiento".</p><button class="btn bg" style="margin-top:18px" onclick="nav('home')">â† Ir al inicio</button></div></div>`;
    return;
  }
  const tots=activeW.exercises.reduce((a,e)=>a+e.sets.length,0);
  const done=activeW.exercises.reduce((a,e)=>a+e.sets.filter(s=>s.done).length,0);
  const pct=tots>0?Math.round(done/tots*100):0;

  let html=`<div class="wp-sticky">
    <div class="wp-row1">
      <div class="wp-title">${activeW.emoji} ${activeW.rn}</div>
      <div class="wp-timer-pill" id="wp-el">0:00</div>
    </div>
    <div class="wp-meta">
      <span class="wp-sets-done">${done}/${tots} series</span>
      <span class="wp-pct">${pct}%</span>
    </div>
    <div class="wp-pbar"><div class="wp-pfill" id="wp-pf" style="width:${pct}%"></div></div>
  </div>`;

  activeW.exercises.forEach((ex,ei)=>{
    const ls0=ex.last?.sets?.[0];
    html+=`<div class="exb" id="exb-${ei}">
      <div class="exb-name">${ex.name}</div>
      <div class="exb-meta">
        ${ex.sets.length}Ã—${ex.rMin}-${ex.rMax} reps &nbsp;Â·&nbsp; Descanso: ${ex.rest}s &nbsp;Â·&nbsp;
        <a href="${ex.video}" target="_blank" rel="noopener" style="color:var(--ac);text-decoration:none;font-weight:700">ğŸ“º VER TÃ‰CNICA</a>
      </div>
      ${ex.notes?`<div class="ex-note-box">ğŸ’¡ ${ex.notes}</div>`:''}
      ${ex.suggest?`<div class="prog-box">âš¡ <div><strong>HOY: ${ex.suggest}kg</strong> â€” Alcanzaste el tope. Â¡Es hora de subir!</div></div>`:''}

      <div class="sets-hdr"><span>#</span><span>PESO kg</span><span>REPS</span><span>RIR</span><span></span></div>
      ${ex.sets.map((s,si)=>{
        const lh=ex.last?.sets?.[si]||ls0;
        return `<div class="set-r ${s.done?'set-done':''}" id="sr-${ei}-${si}">
          <div class="set-num">${s.n}</div>
          <div class="set-field">
            <input type="number" class="set-inp" placeholder="${lh?.w||'â€”'}" value="${s.w}"
              onchange="upS(${ei},${si},'w',this.value)" inputmode="decimal" step="0.5">
            ${lh?.w?`<span class="set-hint">${lh.w}kg</span>`:''}
          </div>
          <div class="set-field">
            <input type="number" class="set-inp" placeholder="${lh?.r||'â€”'}" value="${s.r}"
              onchange="upS(${ei},${si},'r',this.value)" inputmode="numeric">
            ${lh?.r?`<span class="set-hint">${lh.r} reps</span>`:''}
          </div>
          <div class="set-field">
            <input type="number" class="set-inp" placeholder="0-5" value="${s.rir}"
              onchange="upS(${ei},${si},'rir',this.value)" inputmode="numeric" min="0" max="5">
            <span class="set-hint">RIR</span>
          </div>
          <button class="set-chk ${s.done?'ck':''}" onclick="toggleS(${ei},${si},${ex.rest})">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </button>
        </div>`;
      }).join('')}
      <label class="partial-tog">
        <input type="checkbox" ${ex.partial?'checked':''} onchange="upPart(${ei},this.checked)">
        + Parciales en estiramiento al fallo
      </label>
      <button class="add-set" onclick="addS(${ei})">+ Agregar serie</button>
    </div>`;
  });

  html+=`<div class="fin-zone">
    <button class="btn bp btn-w" onclick="finishW()">ğŸ TERMINAR ENTRENAMIENTO</button>
    <button class="btn bdng btn-w bsm" style="margin-top:9px" onclick="if(confirm('Â¿Cancelar sin guardar?')){activeW=null;clearInterval(elIval);skipRT();nav('home')}">Cancelar sin guardar</button>
  </div>`;

  el.innerHTML=html;
  startElapsed();
}

function upS(ei,si,f,v){if(activeW) activeW.exercises[ei].sets[si][f]=v;}
function upPart(ei,v){if(activeW) activeW.exercises[ei].partial=v;}

function toggleS(ei,si,restSec){
  if(!activeW) return;
  const s=activeW.exercises[ei].sets[si];
  s.done=!s.done;
  const btn=document.querySelector(`#sr-${ei}-${si} .set-chk`);
  const row=document.getElementById(`sr-${ei}-${si}`);
  if(btn) btn.classList.toggle('ck',s.done);
  if(row) row.classList.toggle('set-done',s.done);
  if(s.done) startRT(restSec); else stopRT();
  // update bar
  const tots=activeW.exercises.reduce((a,e)=>a+e.sets.length,0);
  const done=activeW.exercises.reduce((a,e)=>a+e.sets.filter(x=>x.done).length,0);
  const pf=document.getElementById('wp-pf');
  if(pf) pf.style.width=`${Math.round(done/tots*100)}%`;
  const pm=document.querySelector('.wp-sets-done');
  if(pm) pm.textContent=`${done}/${tots} series`;
  const pp=document.querySelector('.wp-pct');
  if(pp) pp.textContent=`${Math.round(done/tots*100)}%`;
}

function addS(ei){
  if(!activeW) return;
  const ex=activeW.exercises[ei];
  ex.sets.push({n:ex.sets.length+1,w:'',r:'',rir:'',done:false});
  renderWorkout();
  setTimeout(()=>{
    const b=document.getElementById(`exb-${ei}`);
    if(b) b.scrollIntoView({behavior:'smooth',block:'start'});
  },60);
}

function startElapsed(){
  clearInterval(elIval);
  elIval=setInterval(()=>{
    const el=document.getElementById('wp-el');
    if(el&&activeW) el.textContent=fmtDur(Date.now()-activeW.start);
  },1000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REST TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startRT(secs){
  stopRT();
  rtSecs=secs;
  document.getElementById('rtimer').classList.remove('hidden');
  updRT();
  rtIval=setInterval(()=>{rtSecs--;updRT();if(rtSecs<=0) stopRT();},1000);
}
function updRT(){
  const d=document.getElementById('rtdisp');
  if(d){d.textContent=fmtTimer(rtSecs);d.classList.toggle('urg',rtSecs<=10);}
}
function stopRT(){clearInterval(rtIval);document.getElementById('rtimer').classList.add('hidden');}
function adjRT(d){rtSecs=Math.max(0,rtSecs+d);updRT();}
function skipRT(){stopRT();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FINISH WORKOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function finishW(){
  if(!activeW) return;
  const dur=Date.now()-activeW.start;
  let vol=0,sc=0;
  for(const ex of activeW.exercises){
    const ds=ex.sets.filter(s=>s.done&&s.w&&s.r);
    if(!ds.length) continue;
    ds.forEach(s=>{vol+=(parseFloat(s.w)||0)*(parseInt(s.r)||0);sc++;});
    await spush('ex_'+ex.id,{
      date:new Date().toISOString(),
      sets:ds.map(s=>({w:s.w,r:s.r,rir:s.rir})),
      partial:ex.partial
    });
  }
  const sess={date:new Date().toISOString(),rn:activeW.rn,emoji:activeW.emoji,dow:activeW.dow,dur,vol,sc};
  await spush('sessions',sess);
  clearInterval(elIval);
  stopRT();
  showCel(sess);
  activeW=null;
}

function showCel(s){
  document.getElementById('cel-gif').src=GIFS[Math.floor(Math.random()*GIFS.length)];
  document.getElementById('cel-stats').innerHTML=`
    <div class="cel-stat"><span class="cel-val">${fmtDur(s.dur)}</span><span class="cel-lbl">Tiempo</span></div>
    <div class="cel-stat"><span class="cel-val">${s.sc}</span><span class="cel-lbl">Series</span></div>
    <div class="cel-stat"><span class="cel-val">${Math.round((s.vol||0)/100)/10}k</span><span class="cel-lbl">kg vol.</span></div>`;
  document.getElementById('cel').classList.add('show');
}
function closeCel(){
  document.getElementById('cel').classList.remove('show');
  nav('progress');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderProgress(){
  const el=document.getElementById('v-progress');
  el.innerHTML=`
<h1 class="title hd">PROGRESO</h1>
<div class="sub" style="margin-bottom:14px">Tu evoluciÃ³n semana a semana</div>
<div class="tabs">
  ${['charts','history','prs','volume'].map((t,i)=>`<button class="tab ${t===progTab?'on':''}" onclick="setPTab('${t}')">${['ğŸ“ˆ GrÃ¡ficas','ğŸ“‹ Historial','ğŸ† RÃ©cords','ğŸ“¦ Volumen'][i]}</button>`).join('')}
</div>
<div id="prog-cnt"></div>`;
  renderProgCnt();
}
async function setPTab(t){
  progTab=t;
  document.querySelectorAll('#v-progress .tab').forEach((b,i)=>b.classList.toggle('on',['charts','history','prs','volume'][i]===t));
  renderProgCnt();
}
async function renderProgCnt(){
  const el=document.getElementById('prog-cnt');
  if(!el) return;
  const sessions=await sget('sessions')||[];
  const acc=getComputedStyle(document.documentElement).getPropertyValue('--ac').trim();

  if(progTab==='history'){
    if(!sessions.length){el.innerHTML=emptyState('ğŸ“‹','SIN HISTORIAL','Completa tu primer entrenamiento.');return;}
    el.innerHTML=sessions.slice().reverse().map(s=>`
    <div class="hist-item">
      <div class="hist-date">${new Date(s.date).toLocaleDateString('es',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
      <div class="hist-name">${s.emoji||''} ${s.rn}</div>
      <div class="hist-meta">
        <span>â± ${fmtDur(s.dur)}</span>
        <span>ğŸ“¦ ${Math.round((s.vol||0)/100)/10}k kg</span>
        <span>âœ“ ${s.sc} series</span>
      </div>
    </div>`).join('');return;
  }

  if(progTab==='prs'){
    let html='';
    for(const ex of ALL_EX){
      const h=await exhist(ex.id);
      if(!h.length) continue;
      const pr=Math.max(...h.flatMap(x=>x.sets?.map(s=>parseFloat(s.w)||0)||[0]));
      const allReps=h.flatMap(x=>x.sets?.map(s=>({w:parseFloat(s.w)||0,r:parseInt(s.r)||0}))||[]);
      const maxVol=Math.max(...allReps.map(s=>s.w*s.r));
      if(pr>0) html+=`<div class="pr-item">
        <div>
          <div class="pr-crown">ğŸ† PR</div>
          <div style="font-weight:700;font-size:13px;margin-top:2px">${ex.name}</div>
          <div style="font-size:11px;color:var(--text2)">${ex.g} Â· ${h.length} sesiones</div>
        </div>
        <div style="text-align:right">
          <div class="pr-w">${pr}<span style="font-size:13px;color:var(--text2)">kg</span></div>
          <div style="font-size:11px;color:var(--text3)">1RM est: ${est1RM(pr,h[h.length-1]?.sets?.[0]?.r||8).toFixed(1)}kg</div>
        </div>
      </div>`;
    }
    el.innerHTML=html||emptyState('ğŸ†','SIN RÃ‰CORDS AÃšN','Completa sesiones para ver tus PRs.');
    return;
  }

  if(progTab==='volume'){
    if(sessions.length<2){el.innerHTML=emptyState('ğŸ“¦','POCOS DATOS','Necesitas al menos 2 sesiones.');return;}
    el.innerHTML=`<div class="chart-box"><div class="chart-title">Volumen Total por SesiÃ³n (kg Ã— reps)</div><div class="chart-cnt"><canvas id="ch-vol"></canvas></div></div>
    <div class="chart-box"><div class="chart-title">Frecuencia Semanal</div><div class="chart-cnt"><canvas id="ch-freq"></canvas></div></div>`;
    await tick();
    const last20=sessions.slice(-20);
    mkChart('ch-vol','bar',last20.map(s=>new Date(s.date).toLocaleDateString('es',{day:'numeric',month:'short'})),
      [{data:last20.map(s=>Math.round((s.vol||0)/10)/10),backgroundColor:acc+'88',borderColor:acc,borderWidth:1,borderRadius:4}],acc,{y:{callback:v=>v+'k'}});
    // Weekly frequency
    const wks={};
    sessions.forEach(s=>{
      const d=new Date(s.date);
      const wk=`${d.getFullYear()}-W${getWeekNum(d)}`;
      wks[wk]=(wks[wk]||0)+1;
    });
    const wkKeys=Object.keys(wks).slice(-10);
    mkChart('ch-freq','line',wkKeys.map(w=>w.split('-W')[1]?`Sem ${w.split('-W')[1]}`:w),
      [{data:wkKeys.map(k=>wks[k]),borderColor:acc,backgroundColor:acc+'22',borderWidth:2.5,pointBackgroundColor:acc,pointRadius:4,fill:true,tension:.3}],acc,{});
    return;
  }

  // Charts
  const keyEx=[
    {id:'e08',name:'Press Banca ğŸ”¥'},{id:'e04',name:'Remo Barra'},
    {id:'e14',name:'Sentadilla ğŸ”¥'},{id:'e20',name:'Curl Barra W'},
    {id:'e23',name:'Fondos'},{id:'e26',name:'Press Hombro'},
    {id:'e01',name:'JalÃ³n Unilateral'},{id:'e17',name:'Peso Muerto Rumano'},
  ];
  let html='';
  for(const k of keyEx){
    const h=await exhist(k.id);
    if(h.length>=2) html+=`<div class="chart-box"><div class="chart-title">${k.name}<span style="font-size:11px;color:var(--text3)">&nbsp;${h.length} sesiones</span></div><div class="chart-cnt"><canvas id="ch-${k.id}"></canvas></div></div>`;
  }
  if(!html){el.innerHTML=emptyState('ğŸ“ˆ','POCOS DATOS','Completa 2+ sesiones del mismo ejercicio.');return;}
  el.innerHTML=html;
  await tick();
  for(const k of keyEx){
    const h=await exhist(k.id);
    if(h.length<2) continue;
    const c=document.getElementById('ch-'+k.id);
    if(!c) continue;
    const labels=h.map(x=>new Date(x.date).toLocaleDateString('es',{day:'numeric',month:'short'}));
    const maxW=h.map(x=>Math.max(...(x.sets?.map(s=>parseFloat(s.w)||0)||[0])));
    mkChart('ch-'+k.id,'line',labels,[{data:maxW,borderColor:acc,backgroundColor:acc+'18',borderWidth:2.5,pointBackgroundColor:acc,pointRadius:4,fill:true,tension:.3}],acc,{});
  }
}

function mkChart(id,type,labels,datasets,acc,yOpts){
  const c=document.getElementById(id);
  if(!c) return;
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(c,{type,data:{labels,datasets},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#404060',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(255,255,255,0.04)'}},
        y:{ticks:{color:'#404060',font:{family:'JetBrains Mono',size:10},...yOpts},grid:{color:'rgba(255,255,255,0.04)'}}
      }}});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BODY VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderBody(){
  const el=document.getElementById('v-body');
  const logs=await sget('bodyLogs')||[];
  const last=logs.slice(-1)[0]||{};

  el.innerHTML=`
<h1 class="title hd">CUERPO</h1>
<div class="sub" style="margin-bottom:14px">ComposiciÃ³n corporal y medidas</div>

<div class="card card-glow">
  <div style="font-family:var(--hd);font-size:17px;font-weight:800;letter-spacing:.3px;margin-bottom:13px">ğŸ“Š REGISTRAR HOY</div>
  <div class="body-grid">
    <div class="body-field"><label class="lbl">Peso (kg)</label><input type="number" class="body-inp" id="b-w" placeholder="${last.w||'75.0'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="lbl">MÃºsculo (%)</label><input type="number" class="body-inp" id="b-mp" placeholder="${last.mp||'42'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="lbl">Grasa (%)</label><input type="number" class="body-inp" id="b-fp" placeholder="${last.fp||'18'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="lbl">MÃºsculo (kg)</label><input type="number" class="body-inp" id="b-mk" placeholder="${last.mk||'30'}" step="0.1" inputmode="decimal"></div>
  </div>
  <div style="font-family:var(--hd);font-size:15px;font-weight:800;letter-spacing:.3px;margin:12px 0 10px">ğŸ“ MEDIDAS (cm)</div>
  <div class="body-grid">
    <div class="body-field"><label class="lbl">Brazo Izq.</label><input type="number" class="body-inp" id="b-bi" placeholder="${last.bi||'â€”'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="lbl">Brazo Der.</label><input type="number" class="body-inp" id="b-bd" placeholder="${last.bd||'â€”'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="lbl">Pecho</label><input type="number" class="body-inp" id="b-pe" placeholder="${last.pe||'â€”'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="lbl">Cintura</label><input type="number" class="body-inp" id="b-ci" placeholder="${last.ci||'â€”'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="lbl">Pantorrilla Izq.</label><input type="number" class="body-inp" id="b-pi" placeholder="${last.pi||'â€”'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="lbl">Pantorrilla Der.</label><input type="number" class="body-inp" id="b-pd" placeholder="${last.pd||'â€”'}" step="0.1" inputmode="decimal"></div>
  </div>
  <input class="inp" id="b-notes" placeholder="Notas (ej: en ayunas, post-entreno...)" style="margin:10px 0 13px">
  <button class="btn bp btn-w" onclick="saveBody()">ğŸ’¾ GUARDAR MEDICIÃ“N</button>
</div>

${logs.length>=2?`
<div class="chart-box"><div class="chart-title">âš–ï¸ Peso Corporal (kg)</div><div class="chart-cnt"><canvas id="ch-bw"></canvas></div></div>
<div class="chart-box"><div class="chart-title">ğŸ’ª MÃºsculo % y Grasa %</div><div class="chart-cnt"><canvas id="ch-bm"></canvas></div></div>`:''}

<div class="card">
  <div style="font-family:var(--hd);font-size:17px;font-weight:800;margin-bottom:12px">HISTORIAL</div>
  ${!logs.length?'<div style="text-align:center;color:var(--text3);padding:20px">Sin registros aÃºn</div>':
  logs.slice().reverse().slice(0,20).map((log,i,arr)=>{
    const prev=arr[i+1];
    const dw=prev&&log.w&&prev.w?(parseFloat(log.w)-parseFloat(prev.w)).toFixed(1):null;
    const dm=prev&&log.mp&&prev.mp?(parseFloat(log.mp)-parseFloat(prev.mp)).toFixed(1):null;
    return `<div class="meas-row">
      <div>
        <div class="meas-lbl">${new Date(log.date).toLocaleDateString('es',{day:'numeric',month:'short',year:'numeric'})}</div>
        ${log.notes?`<div style="font-size:11px;color:var(--text3)">${log.notes}</div>`:''}
      </div>
      <div style="text-align:right">
        ${log.w?`<div class="meas-val">${log.w}kg ${dw!=null?`<span class="${parseFloat(dw)>0?'delta-pos':'delta-neg'}">${parseFloat(dw)>0?'+':''}${dw}</span>`:''}</div>`:''}
        ${log.mp?`<div style="font-family:var(--mono);font-size:12px;color:var(--text2)">${log.mp}% mÃºsculo${dm!=null?` <span class="${parseFloat(dm)>0?'delta-pos':'delta-neg'}">${parseFloat(dm)>0?'+':''}${dm}</span>`:''}</div>`:''}
        ${log.bi||log.bd?`<div style="font-size:11px;color:var(--text3)">ğŸ’ª ${log.bi||'â€”'}/${log.bd||'â€”'} cm</div>`:''}
        ${log.pi||log.pd?`<div style="font-size:11px;color:var(--text3)">ğŸ¦µ ${log.pi||'â€”'}/${log.pd||'â€”'} cm</div>`:''}
      </div>
    </div>`;
  }).join('')}
</div>`;

  if(logs.length>=2){
    await tick();
    const acc=getComputedStyle(document.documentElement).getPropertyValue('--ac').trim();
    const lbs=logs.map(l=>new Date(l.date).toLocaleDateString('es',{day:'numeric',month:'short'}));
    mkChart('ch-bw','line',lbs,[{data:logs.map(l=>parseFloat(l.w)||null),borderColor:acc,backgroundColor:acc+'18',borderWidth:2,fill:true,tension:.3,pointRadius:3}],acc,{});
    mkChart('ch-bm','line',lbs,[
      {label:'MÃºsculo%',data:logs.map(l=>parseFloat(l.mp)||null),borderColor:'#8B5CF6',backgroundColor:'rgba(139,92,246,.1)',borderWidth:2,fill:false,tension:.3,pointRadius:3},
      {label:'Grasa%',data:logs.map(l=>parseFloat(l.fp)||null),borderColor:'#EF4444',backgroundColor:'rgba(239,68,68,.1)',borderWidth:2,fill:false,tension:.3,pointRadius:3}
    ],acc,{callback:v=>v+'%'});
    // Fix legend for bm chart
    if(charts['ch-bm']){
      charts['ch-bm'].options.plugins.legend.display=true;
      charts['ch-bm'].options.plugins.legend.labels={color:'#8080A0',font:{family:'JetBrains Mono',size:10}};
      charts['ch-bm'].update();
    }
  }
}
async function saveBody(){
  const fs=['w','mp','fp','mk','bi','bd','pe','ci','pi','pd'];
  const vals={};
  fs.forEach(k=>{const v=document.getElementById('b-'+k)?.value;if(v) vals[k]=v;});
  const notes=document.getElementById('b-notes')?.value||'';
  if(!Object.keys(vals).length){toast('âš ï¸ Ingresa al menos un valor');return;}
  await spush('bodyLogs',{date:new Date().toISOString(),...vals,notes});
  toast('âœ… MediciÃ³n guardada');
  renderBody();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderSettings(){
  const el=document.getElementById('v-settings');
  const sessions=await sget('sessions')||[];
  const bodyLogs=await sget('bodyLogs')||[];
  const curAcc=getComputedStyle(document.documentElement).getPropertyValue('--ac').trim();

  el.innerHTML=`
<h1 class="title hd">AJUSTES</h1>
<div class="sub" style="margin-bottom:16px">PersonalizaciÃ³n y datos</div>

<!-- SYNC STATUS -->
<div class="sync-bar">
  <div class="sync-dot ${useFB&&db?'sd-on':'sd-loc'}"></div>
  <span style="color:var(--text2);font-size:13px">${useFB&&db?'â˜ Firebase activo â€” Sincronizando en la nube':'ğŸ’¾ Solo local â€” Datos en este navegador'}</span>
</div>
${!useFB||!db?`
<div class="card" style="margin-bottom:12px;border-color:rgba(var(--ac2),.3)">
  <div style="font-family:var(--hd);font-size:16px;font-weight:800;margin-bottom:5px">â˜ ACTIVAR SYNC MULTI-DISPOSITIVO</div>
  <div style="font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:12px">Para abrir la app desde cualquier dispositivo y ver siempre tus datos:<br>
    1. <a href="https://console.firebase.google.com" target="_blank" style="color:var(--ac)">console.firebase.google.com</a><br>
    2. Crear proyecto â†’ Firestore Database â†’ Modo test<br>
    3. ConfiguraciÃ³n âš™ â†’ Agregar app web â†’ Copiar config
  </div>
  <input class="fb-inp" id="s-key" placeholder="apiKey (AIzaSy...)">
  <input class="fb-inp" id="s-pid" placeholder="projectId (ej: mi-gym-jaime)">
  <input class="fb-inp" id="s-aid" placeholder="appId (ej: 1:xxx:web:xxx)">
  <button class="btn bp btn-w bsm" onclick="connectFB()" style="margin-top:4px">Conectar Firebase â†’</button>
</div>`:''}

<!-- COLOR TEMA -->
<div class="card" style="margin-bottom:10px">
  <div style="font-family:var(--hd);font-size:16px;font-weight:800;letter-spacing:.3px;margin-bottom:9px">ğŸ¨ COLOR DE LA APP</div>
  <div class="swatches">${ACCENTS.map(a=>`<div class="sw ${a.v===curAcc?'on':''}" style="background:${a.v}" onclick="setAcc('${a.v}','${a.r}')" title="${a.name}"></div>`).join('')}
    <input type="color" value="${curAcc}" title="Personalizado" style="width:34px;height:34px;border-radius:50%;border:2px solid var(--border2);cursor:pointer;padding:2px;background:var(--bg4)" oninput="setAccCust(this.value)">
  </div>
  <div style="font-size:11px;color:var(--text3)">Elige cualquier color que te guste</div>
</div>

<!-- CALCULADORA 1RM -->
<div class="card" style="margin-bottom:10px">
  <div style="font-family:var(--hd);font-size:16px;font-weight:800;margin-bottom:11px">ğŸ§® CALCULADORA 1RM</div>
  <div class="body-grid">
    <div class="body-field"><label class="lbl">Peso (kg)</label><input type="number" class="body-inp" id="rm-w" placeholder="100" inputmode="decimal" step="0.5" oninput="calc1RM()"></div>
    <div class="body-field"><label class="lbl">Reps</label><input type="number" class="body-inp" id="rm-r" placeholder="5" inputmode="numeric" oninput="calc1RM()"></div>
  </div>
  <div id="rm-res" style="display:none">
    <div class="rmcalc-result" id="rm-val">â€”</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-top:9px" id="rm-pcts"></div>
  </div>
</div>

<!-- ROUTINE NOTES -->
<div class="sett-row" onclick="showRoutineEditor()">
  <div><h4>âœï¸ Notas de Rutina</h4><p>Agrega notas personales a los ejercicios</p></div>
  <span class="sett-arrow">â†’</span>
</div>

<!-- EXPORT/IMPORT -->
<div class="sett-row" onclick="exportData()">
  <div><h4>ğŸ“¤ Exportar todo</h4><p>${sessions.length} sesiones Â· ${bodyLogs.length} mediciones</p></div>
  <span class="sett-arrow">â†’</span>
</div>
<div class="sett-row" onclick="importData()">
  <div><h4>ğŸ“¥ Importar backup</h4><p>Carga un archivo JSON</p></div>
  <span class="sett-arrow">â†’</span>
</div>
<div class="sett-row" style="background:rgba(239,68,68,.05);border-color:rgba(239,68,68,.2)" onclick="if(confirm('Â¿Borrar TODOS los datos? Esta acciÃ³n no se puede deshacer.')) clearAll()">
  <div><h4 style="color:var(--red)">ğŸ—‘ Borrar todos los datos</h4><p style="color:rgba(239,68,68,.7)">Irreversible â€” haz backup primero</p></div>
  <span class="sett-arrow" style="color:var(--red)">â†’</span>
</div>

<!-- APP INFO -->
<div class="card" style="text-align:center;padding:28px;margin-top:6px">
  <div style="font-family:var(--hd);font-size:40px;font-weight:900;letter-spacing:3px;line-height:1">HYPER<span style="color:var(--ac)">.</span></div>
  <div style="font-size:11px;color:var(--text3);letter-spacing:1px;margin-top:5px">LAB DE HIPERTROFIA Â· SOLO PARA JAIME<br>Datos guardados localmente ${useFB?'+ nube':''}</div>
  <div style="font-size:11px;color:var(--text3);margin-top:12px">ğŸ’¾ Tus datos nunca se borran automÃ¡ticamente</div>
</div>`;
}

function connectFB(){
  const key=document.getElementById('s-key').value.trim();
  const pid=document.getElementById('s-pid').value.trim();
  const aid=document.getElementById('s-aid').value.trim();
  if(!key||!pid||!aid){toast('âš ï¸ Completa todos los campos');return;}
  const cfg={apiKey:key,projectId:pid,appId:aid,authDomain:`${pid}.firebaseapp.com`,storageBucket:`${pid}.appspot.com`};
  try{
    if(!firebase.apps.length) firebase.initializeApp(cfg);
    else firebase.app();
    db=firebase.firestore();
    useFB=true;
    localStorage.setItem('h3_fbcfg',JSON.stringify(cfg));
    toast('â˜ Firebase conectado! Syncing...');
    renderSettings();
  }catch(e){toast('Error: '+e.message);}
}

function calc1RM(){
  const w=parseFloat(document.getElementById('rm-w')?.value)||0;
  const r=parseInt(document.getElementById('rm-r')?.value)||0;
  if(!w||!r){document.getElementById('rm-res').style.display='none';return;}
  const orm=est1RM(w,r);
  document.getElementById('rm-res').style.display='block';
  document.getElementById('rm-val').textContent=orm.toFixed(1)+' kg estimado';
  const pcts=[100,95,90,85,80,75,70,65];
  document.getElementById('rm-pcts').innerHTML=pcts.map(p=>`
    <div style="background:var(--bg3);border-radius:var(--rsm);padding:8px;text-align:center">
      <div style="font-family:var(--mono);font-size:14px;font-weight:700;color:var(--ac)">${(orm*p/100).toFixed(1)}</div>
      <div style="font-size:9px;color:var(--text3)">${p}%</div>
    </div>`).join('');
}

function est1RM(w,r){return w*(1+r/30);} // Epley formula

function showRoutineEditor(){
  const rows=ALL_EX.map(ex=>`
    <div style="background:var(--bg3);border-radius:var(--rsm);padding:12px;margin-bottom:7px">
      <div style="font-weight:700;font-size:13px;margin-bottom:6px">${ex.name}</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div style="display:flex;flex-direction:column;gap:3px">
          <span style="font-size:9px;color:var(--text3);text-transform:uppercase">Series</span>
          <input type="number" style="width:52px;background:var(--bg4);border:1px solid var(--border2);color:var(--text);padding:6px;border-radius:6px;font-family:var(--mono);font-size:14px;font-weight:700;text-align:center;outline:none" value="${ex.sets}" id="re-${ex.id}-s" min="1" max="8" inputmode="numeric">
        </div>
        <div style="display:flex;flex-direction:column;gap:3px">
          <span style="font-size:9px;color:var(--text3);text-transform:uppercase">Rep mÃ­n</span>
          <input type="number" style="width:52px;background:var(--bg4);border:1px solid var(--border2);color:var(--text);padding:6px;border-radius:6px;font-family:var(--mono);font-size:14px;font-weight:700;text-align:center;outline:none" value="${ex.rMin}" id="re-${ex.id}-rn" min="1" inputmode="numeric">
        </div>
        <div style="display:flex;flex-direction:column;gap:3px">
          <span style="font-size:9px;color:var(--text3);text-transform:uppercase">Rep mÃ¡x</span>
          <input type="number" style="width:52px;background:var(--bg4);border:1px solid var(--border2);color:var(--text);padding:6px;border-radius:6px;font-family:var(--mono);font-size:14px;font-weight:700;text-align:center;outline:none" value="${ex.rMax}" id="re-${ex.id}-rx" min="1" inputmode="numeric">
        </div>
        <div style="display:flex;flex-direction:column;gap:3px">
          <span style="font-size:9px;color:var(--text3);text-transform:uppercase">Descanso s</span>
          <input type="number" style="width:60px;background:var(--bg4);border:1px solid var(--border2);color:var(--text);padding:6px;border-radius:6px;font-family:var(--mono);font-size:14px;font-weight:700;text-align:center;outline:none" value="${ex.rest}" id="re-${ex.id}-rs" min="30" step="15" inputmode="numeric">
        </div>
      </div>
    </div>`).join('');
  document.body.insertAdjacentHTML('beforeend',`
    <div class="overlay open" id="re-overlay" onclick="if(event.target===this)document.getElementById('re-overlay').remove()">
      <div class="sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">âœï¸ EDITAR RUTINA</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:14px">Cambia series, repeticiones y descansos de cualquier ejercicio</div>
        ${rows}
        <button class="btn bp btn-w" onclick="saveRoutineEdits()">ğŸ’¾ GUARDAR CAMBIOS</button>
      </div>
    </div>`);
}
function saveRoutineEdits(){
  ALL_EX.forEach(ex=>{
    const s=document.getElementById('re-'+ex.id+'-s');
    const rn=document.getElementById('re-'+ex.id+'-rn');
    const rx=document.getElementById('re-'+ex.id+'-rx');
    const rs=document.getElementById('re-'+ex.id+'-rs');
    if(s&&parseInt(s.value)>0) ex.sets=parseInt(s.value);
    if(rn&&parseInt(rn.value)>0) ex.rMin=parseInt(rn.value);
    if(rx&&parseInt(rx.value)>0) ex.rMax=parseInt(rx.value);
    if(rs&&parseInt(rs.value)>0) ex.rest=parseInt(rs.value);
  });
  document.getElementById('re-overlay')?.remove();
  toast('âœ… Rutina actualizada');
}

/* ACCENT */
async function setAcc(v,r){applyAccent(v,r);await sset('accent',{v,r});renderSettings();}
async function setAccCust(v){
  const r=`${parseInt(v.slice(1,3),16)},${parseInt(v.slice(3,5),16)},${parseInt(v.slice(5,7),16)}`;
  applyAccent(v,r);await sset('accent',{v,r});
}
function applyAccent(v,r){
  document.documentElement.style.setProperty('--ac',v);
  document.documentElement.style.setProperty('--ac2',r);
}

/* EXPORT / IMPORT */
async function exportData(){
  const sessions=await sget('sessions')||[];
  const bodyLogs=await sget('bodyLogs')||[];
  const exData={};
  for(const ex of ALL_EX){const h=await exhist(ex.id);if(h.length) exData[ex.id]={name:ex.name,history:h};}
  const blob=new Blob([JSON.stringify({exportDate:new Date().toISOString(),userId:UID,sessions,bodyLogs,exercises:exData},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`hyper-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  toast('ğŸ“¤ Backup exportado');
}
function importData(){
  const inp=document.createElement('input');
  inp.type='file';inp.accept='.json';
  inp.onchange=async e=>{
    try{
      const d=JSON.parse(await e.target.files[0].text());
      if(d.sessions) await sset('sessions',d.sessions);
      if(d.bodyLogs) await sset('bodyLogs',d.bodyLogs);
      if(d.exercises) for(const[id,ex] of Object.entries(d.exercises)) await sset('ex_'+id,ex.history);
      toast('ğŸ“¥ Datos importados correctamente');
      renderSettings();
    }catch(err){toast('Error: '+err.message);}
  };
  inp.click();
}
async function clearAll(){
  Object.keys(localStorage).filter(k=>k.startsWith('h3_')&&k!=='h3_fbcfg'&&k!=='h3_accent').forEach(k=>localStorage.removeItem(k));
  if(useFB&&db){try{const col=await db.collection('hyper').doc(UID).collection('data').get();col.forEach(d=>d.ref.delete());}catch(e){}}
  toast('ğŸ—‘ Datos eliminados');
  renderSettings();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmtDur(ms){
  const s=Math.floor(ms/1000);
  const m=Math.floor(s/60);
  const h=Math.floor(m/60);
  if(h>0) return `${h}h ${m%60}m`;
  return `${m}m ${s%60}s`;
}
function fmtTimer(s){return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;}
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}
function emptyState(ico,title,desc){
  return `<div class="empty"><div class="empty-ico">${ico}</div><h3>${title}</h3><p>${desc}</p></div>`;
}
function tick(){return new Promise(r=>setTimeout(r,60));}
function getWeekNum(d){
  const start=new Date(d.getFullYear(),0,1);
  return Math.ceil(((d-start)/86400000+start.getDay()+1)/7);
}

/* Block double-tap zoom on inputs */
document.addEventListener('touchend',e=>{
  if(['INPUT','BUTTON','LABEL'].includes(e.target.tagName)) e.preventDefault();
},{passive:false});
</script>
</body>
</html>
