<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#08080E">
<title>JAIME ¬∑ HYPER</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
/* ============================================================
   CSS VARIABLES ‚Äî THEMING ENGINE
   ============================================================ */
:root {
  --accent: #3D9EFF;
  --accent-rgb: 61,158,255;
  --bg0: #08080E;
  --bg1: #101018;
  --bg2: #181825;
  --bg3: #20202F;
  --bg4: #282838;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --text: #F0F0F8;
  --text2: #8888A8;
  --text3: #44445A;
  --amber: #FFAA00;
  --red: #FF4466;
  --cyan: #00E5CC;
  --mono: 'JetBrains Mono', monospace;
  --body: 'Outfit', sans-serif;
  --display: 'Bebas Neue', sans-serif;
  --r: 12px;
  --r-sm: 7px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { height: 100%; }
body {
  background: var(--bg0);
  color: var(--text);
  font-family: var(--body);
  font-size: 15px;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  overscroll-behavior: none;
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 2px; }

/* ============================================================
   LAYOUT
   ============================================================ */
#app { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
#view-wrap { flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }

/* ============================================================
   BOTTOM NAV ‚Äî minimal, sharp
   ============================================================ */
#nav {
  height: 62px;
  background: var(--bg1);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: stretch;
  flex-shrink: 0;
  padding-bottom: env(safe-area-inset-bottom);
  position: relative;
}
#nav::before {
  content: '';
  position: absolute;
  top: -1px; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(var(--accent-rgb),0.4), transparent);
}
.nav-item {
  flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 3px; background: none; border: none; color: var(--text3);
  cursor: pointer; font-family: var(--body); font-size: 9px; font-weight: 600;
  letter-spacing: 1px; text-transform: uppercase; transition: color 0.2s;
  position: relative;
}
.nav-item.active { color: var(--accent); }
.nav-item.active::after {
  content: '';
  position: absolute;
  top: 0; left: 30%; right: 30%;
  height: 2px;
  background: var(--accent);
  border-radius: 0 0 4px 4px;
}
.nav-item svg { width: 20px; height: 20px; }

/* ============================================================
   VIEWS
   ============================================================ */
.view { padding: 20px 16px 24px; animation: slideUp 0.22s ease; }
@keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

/* ============================================================
   TYPOGRAPHY
   ============================================================ */
.display { font-family: var(--display); letter-spacing: 1px; }
.mono { font-family: var(--mono); }
.accent { color: var(--accent); }
.muted { color: var(--text2); }
.small { font-size: 12px; }
.tiny { font-size: 10px; letter-spacing: 0.5px; }

/* ============================================================
   CARDS
   ============================================================ */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px;
  margin-bottom: 10px;
}
.card-accent {
  border-left: 3px solid var(--accent);
}

/* ============================================================
   BUTTONS
   ============================================================ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  padding: 14px 22px; border-radius: var(--r); border: none; cursor: pointer;
  font-family: var(--body); font-weight: 700; font-size: 14px; letter-spacing: 0.3px;
  transition: all 0.15s; -webkit-appearance: none;
}
.btn-full { width: 100%; }
.btn-primary {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.35);
}
.btn-primary:active { transform: scale(0.97); }
.btn-ghost {
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border2);
}
.btn-ghost:active { background: var(--bg4); }
.btn-sm { padding: 9px 16px; font-size: 13px; border-radius: var(--r-sm); }
.btn-danger { background: rgba(255,68,102,0.15); color: var(--red); }

/* ============================================================
   INPUT
   ============================================================ */
.input {
  background: var(--bg3);
  border: 1px solid var(--border2);
  color: var(--text);
  padding: 12px 14px;
  border-radius: var(--r-sm);
  font-family: var(--body);
  font-size: 15px;
  outline: none;
  width: 100%;
  transition: border-color 0.15s;
}
.input:focus { border-color: var(--accent); }
.input::placeholder { color: var(--text3); }
.input-label { font-size: 11px; color: var(--text2); font-weight: 600; letter-spacing: 0.7px; text-transform: uppercase; margin-bottom: 6px; display: block; }

/* number input no spinners */
input[type=number] { -moz-appearance: textfield; }
input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }

/* ============================================================
   TAGS / PILLS
   ============================================================ */
.tag {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 9px; border-radius: 40px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.3px;
}
.tag-accent { background: rgba(var(--accent-rgb),0.15); color: var(--accent); }
.tag-amber { background: rgba(255,170,0,0.15); color: var(--amber); }
.tag-red { background: rgba(255,68,102,0.15); color: var(--red); }
.tag-cyan { background: rgba(0,229,204,0.12); color: var(--cyan); }
.tag-muted { background: var(--bg4); color: var(--text2); }

/* ============================================================
   SECTION HEADER
   ============================================================ */
.section-head { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 16px; }
.section-title { font-family: var(--display); font-size: 30px; line-height: 1; letter-spacing: 1.5px; }
.section-sub { font-size: 13px; color: var(--text2); margin-top: 3px; }

/* ============================================================
   HOME VIEW
   ============================================================ */
.hero-bar {
  display: flex; justify-content: space-between; align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}
.hero-greeting { font-size: 13px; color: var(--text2); margin-bottom: 2px; }
.hero-name { font-family: var(--display); font-size: 38px; letter-spacing: 2px; line-height: 1; }
.hero-streak {
  background: linear-gradient(135deg, rgba(255,170,0,0.2), rgba(255,170,0,0.05));
  border: 1px solid rgba(255,170,0,0.3);
  border-radius: var(--r); padding: 10px 14px; text-align: center; min-width: 68px;
}
.streak-num { font-family: var(--mono); font-size: 28px; font-weight: 700; color: var(--amber); display: block; }
.streak-lbl { font-size: 9px; color: var(--amber); letter-spacing: 1px; text-transform: uppercase; opacity: 0.8; }

/* quick stats row */
.stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
.stat-box {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 12px 10px; text-align: center;
}
.stat-val { font-family: var(--mono); font-size: 22px; font-weight: 700; display: block; color: var(--text); }
.stat-lbl { font-size: 9px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; }

/* progression alert */
.prog-alert {
  background: linear-gradient(135deg, rgba(var(--accent-rgb),0.12), rgba(var(--accent-rgb),0.04));
  border: 1px solid rgba(var(--accent-rgb),0.3);
  border-radius: var(--r); padding: 12px 14px; margin-bottom: 10px;
  display: flex; align-items: center; gap: 12px;
}
.prog-alert-icon { font-size: 20px; flex-shrink: 0; }
.prog-alert-body { font-size: 13px; line-height: 1.5; }
.prog-alert-body strong { color: var(--accent); font-weight: 700; }

/* today workout card */
.today-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); overflow: hidden; margin-bottom: 10px;
}
.today-card-header {
  padding: 14px 16px;
  background: linear-gradient(135deg, rgba(var(--accent-rgb),0.12), transparent);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.today-card-title { font-family: var(--display); font-size: 22px; letter-spacing: 1px; }
.today-card-meta { font-size: 12px; color: var(--text2); }
.ex-preview {
  padding: 11px 16px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.ex-preview:last-child { border-bottom: none; }
.ex-preview-name { font-size: 14px; font-weight: 500; }
.ex-preview-info { font-size: 11px; color: var(--text2); margin-top: 2px; }
.ex-preview-last { font-family: var(--mono); font-size: 11px; color: var(--accent); }

/* rest card */
.rest-day-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 40px 20px; text-align: center;
}
.rest-day-card .icon { font-size: 52px; margin-bottom: 12px; }
.rest-day-card h3 { font-family: var(--display); font-size: 24px; letter-spacing: 1px; margin-bottom: 8px; }
.rest-day-card p { color: var(--text2); font-size: 14px; line-height: 1.6; }

/* recent sessions */
.session-item {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 13px 15px; margin-bottom: 8px;
  display: flex; align-items: center; justify-content: space-between;
}
.session-info h4 { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
.session-info p { font-size: 12px; color: var(--text2); }
.session-stats { text-align: right; }
.session-vol { font-family: var(--mono); font-size: 15px; font-weight: 700; color: var(--accent); }
.session-dur { font-size: 11px; color: var(--text3); }

/* ============================================================
   WORKOUT PLAYER
   ============================================================ */
.workout-topbar {
  background: var(--bg1);
  border-bottom: 1px solid var(--border);
  padding: 14px 16px 10px;
  position: sticky; top: 0; z-index: 20;
}
.workout-topbar-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.workout-day-title { font-family: var(--display); font-size: 20px; letter-spacing: 1px; }
.workout-timer-pill {
  background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 20px; padding: 5px 12px;
  font-family: var(--mono); font-size: 13px; font-weight: 600;
}
.progress-track { height: 3px; background: var(--bg4); border-radius: 3px; overflow: hidden; }
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), rgba(var(--accent-rgb),0.6));
  border-radius: 3px; transition: width 0.4s ease;
}

/* exercise block */
.ex-block {
  border-bottom: 1px solid var(--border);
  padding: 16px;
  background: var(--bg0);
}
.ex-block-head { margin-bottom: 4px; }
.ex-block-name { font-weight: 700; font-size: 17px; }
.ex-block-meta { font-size: 12px; color: var(--text2); margin-bottom: 12px; }
.ex-note {
  background: rgba(255,170,0,0.08);
  border-left: 2px solid var(--amber);
  border-radius: 0 var(--r-sm) var(--r-sm) 0;
  padding: 8px 10px; margin-bottom: 12px;
  font-size: 12px; color: var(--amber); line-height: 1.5;
}
.prog-badge {
  background: linear-gradient(135deg, rgba(var(--accent-rgb),0.18), rgba(var(--accent-rgb),0.05));
  border: 1px solid rgba(var(--accent-rgb),0.35);
  border-radius: var(--r-sm); padding: 10px 12px; margin-bottom: 12px;
  display: flex; align-items: center; gap: 10px; font-size: 13px;
}
.prog-badge strong { color: var(--accent); }

/* sets table */
.sets-header {
  display: grid; grid-template-columns: 24px 1fr 1fr 1fr 40px;
  gap: 8px; margin-bottom: 8px; padding: 0 2px;
}
.sets-header span {
  font-size: 9px; color: var(--text3); text-transform: uppercase;
  letter-spacing: 0.8px; font-weight: 700; text-align: center;
}
.sets-header span:first-child { text-align: left; }
.set-row {
  display: grid; grid-template-columns: 24px 1fr 1fr 1fr 40px;
  gap: 8px; align-items: center; margin-bottom: 8px;
  transition: opacity 0.2s;
}
.set-row.done-set { opacity: 0.45; }
.set-num-lbl {
  font-family: var(--mono); font-size: 12px; color: var(--text3); text-align: center; font-weight: 700;
}
.set-field { display: flex; flex-direction: column; align-items: center; gap: 1px; }
.set-inp {
  background: var(--bg3); border: 1px solid var(--border2);
  color: var(--text); text-align: center;
  padding: 9px 4px; border-radius: var(--r-sm);
  font-family: var(--mono); font-size: 16px; font-weight: 700;
  outline: none; width: 100%; transition: border-color 0.15s;
  -webkit-appearance: none;
}
.set-inp:focus { border-color: var(--accent); background: var(--bg4); }
.set-inp::placeholder { color: var(--text3); font-size: 12px; }
.set-hint { font-family: var(--mono); font-size: 9px; color: var(--text3); }
.set-check-btn {
  width: 38px; height: 38px; border-radius: 50%;
  border: 2px solid var(--border2); background: none;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.18s; color: var(--text3);
  -webkit-appearance: none;
}
.set-check-btn.done {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
  box-shadow: 0 2px 12px rgba(var(--accent-rgb),0.4);
}
.add-set-btn {
  width: 100%; padding: 10px; margin-top: 6px;
  background: none; border: 1px dashed var(--border2);
  border-radius: var(--r-sm); color: var(--text3);
  font-family: var(--body); font-size: 13px; font-weight: 600;
  cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
}
.add-set-btn:hover { border-color: var(--accent); color: var(--accent); }

.partial-row {
  display: flex; align-items: center; gap: 8px;
  margin-top: 8px; font-size: 12px; color: var(--text2); cursor: pointer;
}
.partial-row input[type=checkbox] { accent-color: var(--accent); width: 15px; height: 15px; }

.finish-zone { padding: 20px 16px 32px; background: var(--bg0); }

/* ============================================================
   REST TIMER ‚Äî floating
   ============================================================ */
#rest-timer {
  position: fixed; bottom: 70px; left: 12px; right: 12px;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--r);
  padding: 12px 16px;
  display: flex; align-items: center; justify-content: space-between;
  z-index: 80;
  box-shadow: 0 8px 40px rgba(0,0,0,0.7);
  transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
#rest-timer.hidden { opacity: 0; transform: translateY(20px) scale(0.95); pointer-events: none; }
.rest-left { display: flex; flex-direction: column; gap: 2px; }
.rest-lbl { font-size: 9px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
.rest-count { font-family: var(--mono); font-size: 32px; font-weight: 700; line-height: 1; }
.rest-count.urgent { color: var(--red); }
.rest-btns { display: flex; gap: 7px; }
.rest-btn {
  background: var(--bg4); border: 1px solid var(--border2);
  color: var(--text2); border-radius: var(--r-sm); padding: 8px 12px;
  cursor: pointer; font-size: 12px; font-weight: 700; font-family: var(--body);
}
.rest-skip { background: var(--accent); color: #fff; border-color: var(--accent); }

/* ============================================================
   PROGRESS VIEW
   ============================================================ */
.tab-row {
  display: flex; background: var(--bg2); border-radius: var(--r-sm);
  padding: 3px; gap: 3px; margin-bottom: 16px;
}
.tab { flex: 1; padding: 9px 6px; border: none; background: none;
  color: var(--text2); border-radius: 6px; cursor: pointer;
  font-family: var(--body); font-size: 13px; font-weight: 700; transition: all 0.2s; }
.tab.on { background: var(--bg4); color: var(--text); }

.chart-wrap {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 16px; margin-bottom: 10px;
}
.chart-lbl { font-size: 13px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
.chart-canvas { height: 160px; position: relative; }

.history-row {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 14px; margin-bottom: 8px;
}
.history-row-date { font-size: 11px; color: var(--text3); margin-bottom: 4px; }
.history-row-title { font-weight: 700; font-size: 15px; margin-bottom: 8px; }
.history-row-meta { display: flex; gap: 14px; font-family: var(--mono); font-size: 12px; color: var(--text2); }

.pr-row {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 14px; margin-bottom: 8px;
  display: flex; align-items: center; justify-content: space-between;
}
.pr-badge-crown {
  font-size: 9px; font-weight: 800; letter-spacing: 0.5px;
  padding: 2px 7px; border-radius: 4px;
  background: linear-gradient(135deg,var(--amber),#FF7700);
  color: #000; text-transform: uppercase; display: inline-block; margin-bottom: 4px;
}
.pr-weight { font-family: var(--mono); font-size: 24px; font-weight: 700; color: var(--amber); }

/* ============================================================
   BODY VIEW
   ============================================================ */
.body-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.body-field { display: flex; flex-direction: column; gap: 5px; }
.body-inp {
  background: var(--bg3); border: 1px solid var(--border2);
  color: var(--text); padding: 12px; border-radius: var(--r-sm);
  font-family: var(--mono); font-size: 20px; font-weight: 700;
  outline: none; width: 100%; text-align: center;
  -webkit-appearance: none;
}
.body-inp:focus { border-color: var(--accent); }

.measure-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 11px 0; border-bottom: 1px solid var(--border);
}
.measure-lbl { font-size: 13px; font-weight: 500; }
.measure-val { font-family: var(--mono); font-size: 15px; font-weight: 700; color: var(--accent); }
.measure-delta-pos { color: #3DFF99; font-size: 11px; }
.measure-delta-neg { color: var(--red); font-size: 11px; }

/* ============================================================
   SETTINGS VIEW
   ============================================================ */
.settings-row {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 15px 16px; margin-bottom: 8px;
  display: flex; align-items: center; justify-content: space-between; cursor: pointer;
}
.settings-row h4 { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
.settings-row p { font-size: 12px; color: var(--text2); }
.settings-row-icon { color: var(--text3); font-size: 18px; }

/* color palette */
.color-swatches { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
.swatch {
  width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
  border: 2px solid transparent; transition: all 0.15s; position: relative;
}
.swatch.active { border-color: #fff; transform: scale(1.1); }
.swatch.active::after {
  content: '‚úì'; position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 14px; font-weight: 700;
}

.sync-indicator { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--bg3); border-radius: var(--r-sm); margin-bottom: 14px; font-size: 13px; }
.sync-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.sync-dot.live { background: #3DFF99; box-shadow: 0 0 8px #3DFF99; }
.sync-dot.local { background: var(--amber); }
.sync-dot.off { background: var(--text3); }

.user-code {
  font-family: var(--mono); font-size: 28px; font-weight: 700;
  text-align: center; letter-spacing: 4px; color: var(--accent);
  background: rgba(var(--accent-rgb),0.08); border: 1px solid rgba(var(--accent-rgb),0.2);
  border-radius: var(--r); padding: 16px; margin: 10px 0;
}

/* ============================================================
   ROUTINE EDITOR
   ============================================================ */
.ex-edit-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 14px; margin-bottom: 8px;
}
.ex-edit-name { font-weight: 700; font-size: 14px; margin-bottom: 6px; }
.ex-edit-meta { display: flex; gap: 8px; align-items: center; }
.ex-edit-inp {
  background: var(--bg4); border: 1px solid var(--border2);
  color: var(--text); padding: 6px 8px; border-radius: 6px;
  font-family: var(--mono); font-size: 14px; font-weight: 600;
  outline: none; width: 60px; text-align: center;
}
.ex-edit-inp:focus { border-color: var(--accent); }

/* ============================================================
   CELEBRATION
   ============================================================ */
#celebration {
  position: fixed; inset: 0; background: rgba(8,8,14,0.97);
  z-index: 200; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 40px 24px; text-align: center;
  opacity: 0; transition: opacity 0.4s; pointer-events: none;
}
#celebration.show { opacity: 1; pointer-events: all; }
.cel-title { font-family: var(--display); font-size: 48px; letter-spacing: 3px; color: var(--accent); margin-bottom: 6px; }
.cel-sub { font-size: 15px; color: var(--text2); margin-bottom: 24px; }
.cel-gif { width: 180px; height: 180px; object-fit: cover; border-radius: var(--r); margin-bottom: 24px; border: 2px solid var(--accent); }
.cel-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 340px; margin-bottom: 28px; }
.cel-stat { background: var(--bg3); border-radius: var(--r-sm); padding: 14px; }
.cel-stat-val { font-family: var(--mono); font-size: 22px; font-weight: 700; color: var(--accent); display: block; }
.cel-stat-lbl { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }

/* ============================================================
   MODAL SHEET
   ============================================================ */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 150; display: flex; align-items: flex-end; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
.overlay.open { opacity: 1; pointer-events: all; }
.sheet {
  background: var(--bg2); border-radius: 20px 20px 0 0; padding: 24px 20px 40px;
  width: 100%; border-top: 1px solid var(--border);
  transform: translateY(24px); transition: transform 0.25s; max-height: 85vh; overflow-y: auto;
}
.overlay.open .sheet { transform: translateY(0); }
.sheet-handle { width: 40px; height: 4px; background: var(--bg4); border-radius: 4px; margin: 0 auto 20px; }
.sheet-title { font-family: var(--display); font-size: 22px; letter-spacing: 1px; margin-bottom: 18px; }

/* ============================================================
   TOAST
   ============================================================ */
#toast {
  position: fixed; top: 18px; left: 50%; transform: translateX(-50%) translateY(-80px);
  background: var(--bg3); border: 1px solid var(--border2); color: var(--text);
  padding: 11px 20px; border-radius: 40px;
  font-size: 13px; font-weight: 600; z-index: 300; white-space: nowrap;
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
#toast.show { transform: translateX(-50%) translateY(0); }

/* ============================================================
   SETUP SCREEN
   ============================================================ */
#setup {
  position: fixed; inset: 0; background: var(--bg0);
  z-index: 500; display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: 32px 24px;
  text-align: center;
}
.setup-logo { font-family: var(--display); font-size: 56px; letter-spacing: 4px; line-height: 1; margin-bottom: 4px; }
.setup-logo span { color: var(--accent); }
.setup-tagline { font-size: 13px; color: var(--text2); margin-bottom: 36px; letter-spacing: 1px; }
.setup-card {
  width: 100%; max-width: 360px; background: var(--bg2);
  border: 1px solid var(--border); border-radius: var(--r);
  padding: 18px; margin-bottom: 10px; cursor: pointer; text-align: left;
  transition: border-color 0.2s;
}
.setup-card:hover { border-color: var(--accent); }
.setup-card-tag { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); margin-bottom: 8px; }
.setup-card-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
.setup-card-desc { font-size: 12px; color: var(--text2); line-height: 1.5; }

#setup-step2 { display: none; width: 100%; max-width: 360px; text-align: left; }
#setup-step3 { display: none; width: 100%; max-width: 360px; text-align: left; }
.fb-input {
  width: 100%; background: var(--bg3); border: 1px solid var(--border2);
  color: var(--text); padding: 11px 12px; border-radius: var(--r-sm);
  font-family: var(--mono); font-size: 12px; outline: none; margin-bottom: 8px;
}
.fb-input::placeholder { color: var(--text3); }
.fb-input:focus { border-color: var(--accent); }
.setup-back { background: none; border: none; color: var(--text2); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 4px; margin-bottom: 16px; font-family: var(--body); }

/* empty state */
.empty { text-align: center; padding: 48px 24px; }
.empty-icon { font-size: 48px; margin-bottom: 16px; }
.empty h3 { font-family: var(--display); font-size: 22px; letter-spacing: 1px; margin-bottom: 8px; }
.empty p { color: var(--text2); font-size: 14px; line-height: 1.6; }
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast"></div>

<!-- REST TIMER -->
<div id="rest-timer" class="hidden">
  <div class="rest-left">
    <span class="rest-lbl">Descanso</span>
    <span class="rest-count" id="rest-display">2:00</span>
  </div>
  <div class="rest-btns">
    <button class="rest-btn" onclick="adjTimer(-30)">‚àí30</button>
    <button class="rest-btn" onclick="adjTimer(30)">+30</button>
    <button class="rest-btn rest-skip" onclick="skipTimer()">‚úì Skip</button>
  </div>
</div>

<!-- CELEBRATION -->
<div id="celebration">
  <div class="cel-title">LISTO!</div>
  <div class="cel-sub" id="cel-sub">As√≠ se construye m√∫sculo, Jaime üí™</div>
  <img id="cel-gif" class="cel-gif" src="" alt="">
  <div class="cel-stats" id="cel-stats"></div>
  <button class="btn btn-primary btn-full" style="max-width:320px" onclick="closeCel()">Ver resumen</button>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
  <div id="view-wrap">
    <div id="v-home" class="view"></div>
    <div id="v-workout" style="display:none"></div>
    <div id="v-progress" class="view" style="display:none"></div>
    <div id="v-body" class="view" style="display:none"></div>
    <div id="v-settings" class="view" style="display:none"></div>
  </div>
  <nav id="nav">
    <button class="nav-item active" id="ni-home" onclick="go('home')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      INICIO
    </button>
    <button class="nav-item" id="ni-workout" onclick="go('workout')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
      WORKOUT
    </button>
    <button class="nav-item" id="ni-progress" onclick="go('progress')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      PROGRESO
    </button>
    <button class="nav-item" id="ni-body" onclick="go('body')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><path d="M12 8v6M9 20l3-6 3 6M7 20h10M9 12H7M15 12h2"/></svg>
      CUERPO
    </button>
    <button class="nav-item" id="ni-settings" onclick="go('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      AJUSTES
    </button>
  </nav>
</div>

<!-- SETUP SCREEN -->
<div id="setup">
  <div id="setup-step1" style="display:flex;flex-direction:column;align-items:center;width:100%;max-width:360px">
    <div class="setup-logo">HYPER<span>.</span></div>
    <div class="setup-tagline">LAB DE HIPERTROFIA ¬∑ JAIME</div>
    <div class="setup-card" onclick="localMode()">
      <div class="setup-card-tag">‚ö° Instant√°neo</div>
      <div class="setup-card-title">Empezar ahora</div>
      <div class="setup-card-desc">Sin configuraci√≥n. Datos guardados en este dispositivo. Funciona offline siempre.</div>
    </div>
    <div class="setup-card" onclick="showFBSetup()">
      <div class="setup-card-tag">‚òÅ Multi-dispositivo</div>
      <div class="setup-card-title">Con Firebase (Gratis)</div>
      <div class="setup-card-desc">Abre la app desde cualquier tel√©fono o PC y tus datos aparecen autom√°ticamente.</div>
    </div>
    <div class="setup-card" onclick="showExistingSetup()">
      <div class="setup-card-tag">üîë Ya tengo cuenta</div>
      <div class="setup-card-title">Acceder con mi c√≥digo</div>
      <div class="setup-card-desc">Si ya configuraste la app en otro dispositivo, ingresa tu c√≥digo de usuario.</div>
    </div>
  </div>

  <div id="setup-step2">
    <button class="setup-back" onclick="showStep1()">‚Üê Atr√°s</button>
    <div style="font-size:15px;font-weight:700;margin-bottom:6px">Conectar Firebase</div>
    <div style="font-size:12px;color:var(--text2);line-height:1.8;margin-bottom:16px">
      1. Ir a <strong style="color:var(--text)">console.firebase.google.com</strong><br>
      2. Crear proyecto ‚Üí Firestore ‚Üí Modo test<br>
      3. Configuraci√≥n ‚öô ‚Üí Agregar app web ‚Üí Copiar config
    </div>
    <input class="fb-input" id="s2-key" placeholder="apiKey (ej: AIzaSy...)">
    <input class="fb-input" id="s2-pid" placeholder="projectId (ej: mi-gym-app)">
    <input class="fb-input" id="s2-aid" placeholder="appId (ej: 1:123:web:abc)">
    <button class="btn btn-primary btn-full" style="margin-top:6px" onclick="connectFB(false)">Conectar y empezar</button>
  </div>

  <div id="setup-step3">
    <button class="setup-back" onclick="showStep1()">‚Üê Atr√°s</button>
    <div style="font-size:15px;font-weight:700;margin-bottom:12px">Ingresar con mi c√≥digo</div>
    <input class="fb-input" id="s3-uid" placeholder="Tu c√≥digo (ej: JAIME-X7K2P)" style="font-size:16px;text-align:center;letter-spacing:3px;font-weight:700">
    <div style="font-size:12px;color:var(--text2);margin:12px 0">+ Config de Firebase:</div>
    <input class="fb-input" id="s3-key" placeholder="apiKey">
    <input class="fb-input" id="s3-pid" placeholder="projectId">
    <input class="fb-input" id="s3-aid" placeholder="appId">
    <button class="btn btn-primary btn-full" style="margin-top:6px" onclick="connectFB(true)">Acceder</button>
  </div>
</div>

<script>
// ================================================================
// ROUTINE DATA ‚Äî JAIME (from Excel)
// ================================================================
const DAYS = {
  0: { name:'DESCANSO', emoji:'üò¥', rest:true, exercises:[] },
  1: {
    name:'ESPALDA & B√çCEPS', emoji:'üîµ', color:'#3D9EFF', rest:false,
    exercises:[
      { id:'e1', name:'Jal√≥n unilateral desde arriba', g:'Espalda', sets:4, rMin:8, rMax:12, rest:120, type:'isolation',
        notes:'Conexi√≥n mente-m√∫sculo, estiramiento completo', video:'https://www.youtube.com/results?search_query=cable+pulldown+one+arm' },
      { id:'e2', name:'Remo a un brazo con mancuerna', g:'Espalda', sets:4, rMin:8, rMax:12, rest:120, type:'compound',
        notes:'Foco en contraer dorsal, no tirar con b√≠ceps', video:'https://www.youtube.com/results?search_query=dumbbell+one+arm+row' },
      { id:'e3', name:'Jal√≥n m√°quina agarre neutro', g:'Espalda', sets:3, rMin:10, rMax:12, rest:90, type:'isolation',
        notes:'Mantiene tensi√≥n constante', video:'https://www.youtube.com/results?search_query=neutral+grip+lat+pulldown' },
      { id:'e4', name:'Remo con barra o polea baja', g:'Espalda', sets:3, rMin:8, rMax:12, rest:120, type:'compound',
        notes:'Movimiento compuesto para densidad', video:'https://www.youtube.com/results?search_query=barbell+row+form' },
      { id:'e5', name:'Curl barra (recta o W)', g:'B√≠ceps', sets:3, rMin:8, rMax:12, rest:90, type:'compound',
        notes:'Movimiento base, carga progresiva', video:'https://www.youtube.com/results?search_query=barbell+curl+form' },
      { id:'e6', name:'Curl mancuernas banco inclinado', g:'B√≠ceps', sets:3, rMin:10, rMax:12, rest:90, type:'isolation',
        notes:'Estiramiento m√°ximo b√≠ceps largo', video:'https://www.youtube.com/results?search_query=incline+dumbbell+curl' },
      { id:'e7', name:'Elevaci√≥n tal√≥n de pie', g:'Pantorrillas', sets:3, rMin:12, rMax:15, rest:60, type:'isolation',
        notes:'Foco en gastrocnemio (gemelos)', video:'https://www.youtube.com/results?search_query=standing+calf+raise' }
    ]
  },
  2: {
    name:'PECHO & TR√çCEPS', emoji:'üî¥', color:'#FF4466', rest:false,
    exercises:[
      { id:'e8', name:'Press plano con barra', g:'Pecho', sets:4, rMin:6, rMax:10, rest:180, type:'compound',
        notes:'üî• MOVIMIENTO REY ‚Äî Progresi√≥n principal. Carga m√°xima.', video:'https://www.youtube.com/results?search_query=bench+press+form' },
      { id:'e9', name:'Press plano con mancuernas', g:'Pecho', sets:3, rMin:8, rMax:12, rest:150, type:'compound',
        notes:'Mayor rango de movimiento', video:'https://www.youtube.com/results?search_query=dumbbell+bench+press' },
      { id:'e10', name:'Press inclinado con barra', g:'Pecho', sets:3, rMin:8, rMax:12, rest:150, type:'compound',
        notes:'√ânfasis pectoral superior', video:'https://www.youtube.com/results?search_query=incline+barbell+press' },
      { id:'e11', name:'Aperturas en polea (cruce)', g:'Pecho', sets:3, rMin:10, rMax:15, rest:90, type:'isolation',
        notes:'Tensi√≥n constante, estiramiento profundo', video:'https://www.youtube.com/results?search_query=cable+crossover+chest' },
      { id:'e12', name:'Jal√≥n tr√≠ceps en polea', g:'Tr√≠ceps', sets:3, rMin:8, rMax:12, rest:90, type:'isolation',
        notes:'Cabeza lateral + medial', video:'https://www.youtube.com/results?search_query=cable+tricep+pushdown' },
      { id:'e13', name:'Patada de tr√≠ceps en polea', g:'Tr√≠ceps', sets:3, rMin:10, rMax:12, rest:90, type:'isolation',
        notes:'Contracci√≥n pico, sin estr√©s codos', video:'https://www.youtube.com/results?search_query=cable+tricep+kickback' }
    ]
  },
  3: {
    name:'PIERNAS', emoji:'üü¢', color:'#00CC77', rest:false,
    exercises:[
      { id:'e14', name:'Sentadilla con barra', g:'Piernas', sets:4, rMin:6, rMax:10, rest:180, type:'compound',
        notes:'üî• REY tren inferior ‚Äî Profundidad controlada', video:'https://www.youtube.com/results?search_query=barbell+squat+form' },
      { id:'e15', name:'Prensa', g:'Piernas', sets:3, rMin:8, rMax:12, rest:150, type:'compound',
        notes:'Volumen sin fatiga de core', video:'https://www.youtube.com/results?search_query=leg+press+form' },
      { id:'e16', name:'Curl femoral', g:'Piernas', sets:3, rMin:8, rMax:12, rest:90, type:'isolation',
        notes:'Aislamiento isquiotibiales', video:'https://www.youtube.com/results?search_query=leg+curl+seated' },
      { id:'e17', name:'Peso muerto rumano', g:'Piernas', sets:3, rMin:8, rMax:10, rest:180, type:'compound',
        notes:'Cadena posterior completa', video:'https://www.youtube.com/results?search_query=romanian+deadlift' },
      { id:'e18', name:'Elevaci√≥n tal√≥n en prensa', g:'Pantorrillas', sets:4, rMin:10, rMax:15, rest:60, type:'isolation',
        notes:'Gastrocnemio con rodilla extendida', video:'https://www.youtube.com/results?search_query=leg+press+calf+raise' },
      { id:'e19', name:'Elevaci√≥n tal√≥n sentado', g:'Pantorrillas', sets:3, rMin:12, rMax:20, rest:60, type:'isolation',
        notes:'S√≥leo (m√∫sculo profundo)', video:'https://www.youtube.com/results?search_query=seated+calf+raise' }
    ]
  },
  4: {
    name:'BRAZOS (√âNFASIS)', emoji:'üü°', color:'#FFAA00', rest:false,
    exercises:[
      { id:'e20', name:'Curl con barra W', g:'B√≠ceps', sets:4, rMin:8, rMax:12, rest:120, type:'compound',
        notes:'üî• Base b√≠ceps ‚Äî Carga m√°xima', video:'https://www.youtube.com/results?search_query=ez+bar+curl' },
      { id:'e21', name:'Curl martillo con mancuernas', g:'B√≠ceps', sets:3, rMin:8, rMax:12, rest:90, type:'isolation',
        notes:'Braquial + b√≠ceps, protege mu√±ecas', video:'https://www.youtube.com/results?search_query=hammer+curl' },
      { id:'e22', name:'Curl en polea', g:'B√≠ceps', sets:3, rMin:12, rMax:15, rest:60, type:'isolation',
        notes:'Bombeo final, tensi√≥n constante', video:'https://www.youtube.com/results?search_query=cable+bicep+curl' },
      { id:'e23', name:'Fondos en paralelas', g:'Tr√≠ceps', sets:4, rMin:8, rMax:12, rest:120, type:'compound',
        notes:'üî• Compuesto para las 3 cabezas', video:'https://www.youtube.com/results?search_query=parallel+bar+dips' },
      { id:'e24', name:'Extensi√≥n tr√≠ceps en polea', g:'Tr√≠ceps', sets:3, rMin:8, rMax:12, rest:90, type:'isolation',
        notes:'Cabeza lateral', video:'https://www.youtube.com/results?search_query=cable+tricep+extension' },
      { id:'e25', name:'Patada tr√≠ceps en polea', g:'Tr√≠ceps', sets:3, rMin:10, rMax:12, rest:90, type:'isolation',
        notes:'Contracci√≥n m√°xima cabeza larga', video:'https://www.youtube.com/results?search_query=cable+tricep+kickback' }
    ]
  },
  5: {
    name:'HOMBROS & ESPALDA 2', emoji:'‚ö™', color:'#AA88FF', rest:false,
    exercises:[
      { id:'e26', name:'Press hombro (m√°quina/barra)', g:'Hombros', sets:4, rMin:8, rMax:12, rest:120, type:'compound',
        notes:'Deltoides anterior + medio', video:'https://www.youtube.com/results?search_query=shoulder+press+machine' },
      { id:'e27', name:'Elevaciones laterales', g:'Hombros', sets:3, rMin:10, rMax:15, rest:90, type:'isolation',
        notes:'Aislamiento deltoides medio (ancho)', video:'https://www.youtube.com/results?search_query=dumbbell+lateral+raise' },
      { id:'e28', name:'Posterior en polea', g:'Hombros', sets:3, rMin:10, rMax:15, rest:90, type:'isolation',
        notes:'Deltoides posterior + trapecio', video:'https://www.youtube.com/results?search_query=cable+rear+delt+fly' },
      { id:'e29', name:'Jal√≥n/remo ligero (t√©cnica)', g:'Espalda', sets:3, rMin:12, rMax:15, rest:90, type:'isolation',
        notes:'Peso moderado 60-70%, conexi√≥n neural', video:'https://www.youtube.com/results?search_query=cable+row+light' },
      { id:'e30', name:'Elevaci√≥n tal√≥n de pie', g:'Pantorrillas', sets:3, rMin:12, rMax:15, rest:60, type:'isolation',
        notes:'Cierre semanal pantorrillas', video:'https://www.youtube.com/results?search_query=standing+calf+raise' }
    ]
  },
  6: { name:'DESCANSO', emoji:'üò¥', rest:true, exercises:[] }
};

const ALL_EX = Object.values(DAYS).flatMap(d=>d.exercises||[]);
const CAT_GIFS = [
  'https://media.giphy.com/media/VbnUQpnihPSIgIXuZv/giphy.gif',
  'https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif',
  'https://media.giphy.com/media/3oriO6qJiXajN0TksU/giphy.gif',
  'https://media.giphy.com/media/Nm8ZPAGOwZUQM/giphy.gif',
  'https://media.giphy.com/media/ICOgUNjpvO0PC/giphy.gif',
];

const ACCENT_COLORS = [
  { name:'Azul El√©ctrico', v:'#3D9EFF', rgb:'61,158,255' },
  { name:'Naranja Fuego', v:'#FF6B2B', rgb:'255,107,43' },
  { name:'Cyan Neon', v:'#00E5CC', rgb:'0,229,204' },
  { name:'Violeta', v:'#AA44FF', rgb:'170,68,255' },
  { name:'Rojo Plasma', v:'#FF3366', rgb:'255,51,102' },
  { name:'Amarillo', v:'#FFD700', rgb:'255,215,0' },
  { name:'Rosa', v:'#FF60A8', rgb:'255,96,168' },
  { name:'Blanco', v:'#FFFFFF', rgb:'255,255,255' },
];

// ================================================================
// APP STATE
// ================================================================
let db = null, userId = null, useFB = false;
let curView = 'home', progTab = 'charts';
let activeW = null; // active workout
let timerSecs = 0, timerIval = null, elapsedIval = null;
let charts = {};
let customRoutine = {}; // per-day exercise overrides

// ================================================================
// STORAGE
// ================================================================
async function get(key) {
  if (useFB && db && userId) {
    try {
      const d = await db.collection('users').doc(userId).collection('data').doc(key).get();
      if (d.exists) return d.data().v;
    } catch(e){}
  }
  const r = localStorage.getItem('ht2_'+key);
  return r ? JSON.parse(r) : null;
}
async function set(key, val) {
  localStorage.setItem('ht2_'+key, JSON.stringify(val));
  if (useFB && db && userId) {
    try { await db.collection('users').doc(userId).collection('data').doc(key).set({ v: val }); } catch(e){}
  }
}
async function push(key, item) {
  let arr = await get(key) || [];
  arr.push(item);
  await set(key, arr);
  return arr;
}
async function getExHist(id) { return await get('ex_'+id) || []; }

// ================================================================
// BOOT
// ================================================================
async function boot() {
  const cfg = localStorage.getItem('ht2_cfg');
  if (cfg) {
    const c = JSON.parse(cfg);
    userId = c.userId; useFB = c.useFB;
    if (useFB && c.fbCfg) {
      try {
        if (!firebase.apps.length) firebase.initializeApp(c.fbCfg);
        else firebase.app();
        db = firebase.firestore();
      } catch(e) { useFB = false; }
    }
    // load custom accent
    const accent = await get('accent');
    if (accent) applyAccent(accent.v, accent.rgb);
    launch();
  }
}
boot();

function launch() {
  document.getElementById('setup').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  renderHome();
}

// ================================================================
// SETUP
// ================================================================
function showStep1() {
  document.getElementById('setup-step1').style.display = 'flex';
  document.getElementById('setup-step2').style.display = 'none';
  document.getElementById('setup-step3').style.display = 'none';
}
function showFBSetup() {
  document.getElementById('setup-step1').style.display = 'none';
  document.getElementById('setup-step2').style.display = 'block';
}
function showExistingSetup() {
  document.getElementById('setup-step1').style.display = 'none';
  document.getElementById('setup-step3').style.display = 'block';
}

function localMode() {
  userId = genId();
  useFB = false;
  localStorage.setItem('ht2_cfg', JSON.stringify({ userId, useFB:false }));
  launch();
}

function connectFB(existing) {
  const key = existing ? document.getElementById('s3-key').value.trim() : document.getElementById('s2-key').value.trim();
  const pid = existing ? document.getElementById('s3-pid').value.trim() : document.getElementById('s2-pid').value.trim();
  const aid = existing ? document.getElementById('s3-aid').value.trim() : document.getElementById('s2-aid').value.trim();
  const uid = existing ? document.getElementById('s3-uid').value.trim().toUpperCase() : null;
  if (!key || !pid || !aid) { toast('Completa todos los campos'); return; }
  const fbCfg = { apiKey:key, projectId:pid, appId:aid, authDomain:`${pid}.firebaseapp.com`, storageBucket:`${pid}.appspot.com` };
  try {
    if (!firebase.apps.length) firebase.initializeApp(fbCfg);
    else firebase.app();
    db = firebase.firestore();
    useFB = true;
    userId = uid || genId();
    localStorage.setItem('ht2_cfg', JSON.stringify({ userId, useFB:true, fbCfg }));
    toast('‚òÅ Firebase conectado!');
    launch();
  } catch(e) { toast('Error: ' + e.message); }
}

function genId() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return 'JAIME-' + Array.from({length:5}, ()=>c[Math.floor(Math.random()*c.length)]).join('');
}

// ================================================================
// NAVIGATION
// ================================================================
function go(v) {
  ['home','workout','progress','body','settings'].forEach(n => {
    const el = document.getElementById('v-'+n);
    const ni = document.getElementById('ni-'+n);
    if (el) el.style.display = n===v ? 'block' : 'none';
    if (ni) ni.classList.toggle('active', n===v);
  });
  document.getElementById('view-wrap').scrollTop = 0;
  curView = v;
  if (v==='home') renderHome();
  else if (v==='workout') renderWorkout();
  else if (v==='progress') renderProgress();
  else if (v==='body') renderBody();
  else if (v==='settings') renderSettings();
}

// ================================================================
// HOME
// ================================================================
async function renderHome() {
  const el = document.getElementById('v-home');
  const today = new Date();
  const dow = today.getDay();
  const day = DAYS[dow];
  const sessions = await get('sessions') || [];
  const body = (await get('bodyLogs') || []).slice(-1)[0] || {};

  // streak
  let streak = 0;
  const dates = [...new Set(sessions.map(s=>s.date?.split('T')[0]))].sort().reverse();
  let ref = new Date();
  for (const d of dates) {
    const diff = Math.floor((ref - new Date(d)) / 86400000);
    if (diff <= 1) { streak++; ref = new Date(d); } else break;
  }

  // weekly volume
  const wkVol = sessions.filter(s=>Date.now()-new Date(s.date)<7*86400000)
    .reduce((a,s)=>a+(s.vol||0),0);

  // progression alerts
  const alerts = [];
  for (const ex of (day.exercises||[])) {
    const h = await getExHist(ex.id);
    if (h.length >= 1) {
      const last = h[h.length-1];
      const hitMax = last.sets?.some(s=>parseInt(s.r)>=ex.rMax);
      const goodRIR = last.sets?.some(s=>parseInt(s.rir)>1);
      if (hitMax && goodRIR) {
        const pw = Math.max(...(last.sets?.map(s=>parseFloat(s.w)||0)||[0]));
        alerts.push({ name:ex.name, w:pw+2.5 });
      }
    }
  }

  const recent = sessions.slice(-4).reverse();

  el.innerHTML = `
<div class="hero-bar">
  <div>
    <div class="hero-greeting">${today.toLocaleDateString('es',{weekday:'long',day:'numeric',month:'long'})}</div>
    <div class="hero-name">JAIME</div>
    ${day.rest ? `<div style="margin-top:6px"><span class="tag tag-muted">D√≠a de descanso</span></div>` :
    `<div style="margin-top:6px"><span class="tag tag-accent">${day.emoji} ${day.name}</span></div>`}
  </div>
  <div class="hero-streak">
    <span class="streak-num">${streak}</span>
    <span class="streak-lbl">Racha</span>
  </div>
</div>

<div class="stats-row">
  <div class="stat-box">
    <span class="stat-val mono">${body.w||'‚Äî'}</span>
    <span class="stat-lbl">Peso kg</span>
  </div>
  <div class="stat-box">
    <span class="stat-val mono">${body.mp||'‚Äî'}</span>
    <span class="stat-lbl">M√∫sculo %</span>
  </div>
  <div class="stat-box">
    <span class="stat-val mono">${wkVol>0?Math.round(wkVol/100)/10+'k':'‚Äî'}</span>
    <span class="stat-lbl">Vol sem.</span>
  </div>
</div>

${alerts.map(a=>`
<div class="prog-alert">
  <div class="prog-alert-icon">‚ö°</div>
  <div class="prog-alert-body"><strong>+2.5kg en ${a.name}</strong><br>Alcanzaste el tope la semana pasada ‚Üí intenta <strong>${a.w}kg</strong> hoy</div>
</div>`).join('')}

${!day.rest ? `
<div class="today-card">
  <div class="today-card-header">
    <div>
      <div class="today-card-title">${day.emoji} ${day.name}</div>
      <div class="today-card-meta">${day.exercises.length} ejercicios</div>
    </div>
    <span class="tag tag-accent">${day.exercises.reduce((a,e)=>a+e.sets,0)} series</span>
  </div>
  ${await renderHomePreviews(day.exercises)}
  <div style="padding:14px 16px">
    <button class="btn btn-primary btn-full" onclick="startWorkout(${dow})">
      ‚ñ∂ INICIAR ENTRENAMIENTO
    </button>
  </div>
</div>` : `
<div class="rest-day-card">
  <div class="icon">üò¥</div>
  <h3>D√çA DE DESCANSO</h3>
  <p>Ma√±ana vuelves m√°s fuerte.<br>Duerme bien y come suficiente prote√≠na.</p>
</div>`}

${recent.length>0 ? `
<div style="margin-top:16px">
  <div style="font-family:var(--display);font-size:18px;letter-spacing:1px;margin-bottom:10px;color:var(--text2)">√öLTIMAS SESIONES</div>
  ${recent.map(s=>`
  <div class="session-item">
    <div class="session-info">
      <h4>${s.rn||'Entrenamiento'}</h4>
      <p>${new Date(s.date).toLocaleDateString('es',{weekday:'short',day:'numeric',month:'short'})} ¬∑ ${s.sc||0} series</p>
    </div>
    <div class="session-stats">
      <div class="session-vol">${Math.round((s.vol||0)/100)/10}k</div>
      <div class="session-dur">${fmtDur(s.dur)}</div>
    </div>
  </div>`).join('')}
</div>` : ''}`;
}

async function renderHomePreviews(exercises) {
  let h = '';
  for (const ex of exercises) {
    const hist = await getExHist(ex.id);
    const last = hist.slice(-1)[0]?.sets?.[0];
    h += `<div class="ex-preview">
      <div>
        <div class="ex-preview-name">${ex.name}</div>
        <div class="ex-preview-info">${ex.sets}√ó${ex.rMin}-${ex.rMax} ¬∑ ${ex.g} ¬∑ ${ex.rest}s</div>
      </div>
      ${last ? `<div class="ex-preview-last mono">${last.w}√ó${last.r}</div>` : '<span class="tag tag-muted tiny">NUEVO</span>'}
    </div>`;
  }
  return h;
}

// ================================================================
// WORKOUT PLAYER
// ================================================================
async function startWorkout(dow) {
  const day = DAYS[dow];
  const exercises = [];
  for (const ex of day.exercises) {
    const hist = await getExHist(ex.id);
    const last = hist.slice(-1)[0];
    let suggest = null;
    if (last) {
      const hitMax = last.sets?.some(s=>parseInt(s.r)>=ex.rMax);
      const goodRIR = last.sets?.some(s=>parseInt(s.rir)>1);
      if (hitMax && goodRIR) {
        const pw = Math.max(...(last.sets?.map(s=>parseFloat(s.w)||0)||[0]));
        suggest = pw + 2.5;
      }
    }
    exercises.push({
      ...ex,
      last,
      suggest,
      partial: false,
      sets: Array.from({length:ex.sets},(_,i)=>({i:i+1,w:'',r:'',rir:'',done:false}))
    });
  }
  activeW = { dow, rn:day.name, start:Date.now(), exercises };
  go('workout');
}

function renderWorkout() {
  const el = document.getElementById('v-workout');
  if (!activeW) {
    el.innerHTML = `<div class="view">
      <div class="empty"><div class="empty-icon">üèãÔ∏è</div><h3>SIN WORKOUT ACTIVO</h3>
      <p>Ve al inicio y selecciona el entrenamiento del d√≠a.</p>
      <button class="btn btn-ghost" style="margin-top:20px" onclick="go('home')">Ir al inicio</button>
      </div></div>`;
    return;
  }
  const totalSets = activeW.exercises.reduce((a,e)=>a+e.sets.length,0);
  const doneSets = activeW.exercises.reduce((a,e)=>a+e.sets.filter(s=>s.done).length,0);
  const pct = totalSets>0 ? Math.round(doneSets/totalSets*100) : 0;

  let html = `
<div class="workout-topbar">
  <div class="workout-topbar-row">
    <div class="workout-day-title">${DAYS[activeW.dow].emoji} ${activeW.rn}</div>
    <div class="workout-timer-pill mono" id="w-elapsed">0:00</div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
    <span style="font-size:12px;color:var(--text3)">${doneSets}/${totalSets}</span>
    <span style="font-size:12px;color:var(--accent);font-weight:700">${pct}%</span>
  </div>
  <div class="progress-track"><div class="progress-fill" id="prog-fill" style="width:${pct}%"></div></div>
</div>`;

  activeW.exercises.forEach((ex, ei) => {
    const lastSet0 = ex.last?.sets?.[0];
    html += `
<div class="ex-block" id="exb-${ei}">
  <div class="ex-block-head">
    <div class="ex-block-name">${ex.name}</div>
    <div class="ex-block-meta">
      ${ex.sets.length}√ó${ex.rMin}-${ex.rMax} reps ¬∑ ${ex.rest}s descanso
      <a href="${ex.video}" target="_blank" style="color:var(--accent);margin-left:8px;text-decoration:none;font-weight:700">üì∫ VER</a>
    </div>
  </div>
  ${ex.notes ? `<div class="ex-note">${ex.notes}</div>` : ''}
  ${ex.suggest ? `<div class="prog-badge">‚ö° <div><strong>Sube a ${ex.suggest}kg hoy</strong> ‚Äî Lo lograste la √∫ltima sesi√≥n, toca progresar</div></div>` : ''}
  
  <div class="sets-header">
    <span>#</span><span>PESO kg</span><span>REPS</span><span>RIR</span><span></span>
  </div>

  ${ex.sets.map((s,si) => {
    const lh = ex.last?.sets?.[si] || lastSet0;
    return `<div class="set-row ${s.done?'done-set':''}" id="sr-${ei}-${si}">
      <div class="set-num-lbl">${s.i}</div>
      <div class="set-field">
        <input type="number" class="set-inp" placeholder="${lh?.w||'‚Äî'}" value="${s.w}"
          onchange="upSet(${ei},${si},'w',this.value)" inputmode="decimal" step="0.5">
        ${lh?.w?`<span class="set-hint">${lh.w}</span>`:''}
      </div>
      <div class="set-field">
        <input type="number" class="set-inp" placeholder="${lh?.r||'‚Äî'}" value="${s.r}"
          onchange="upSet(${ei},${si},'r',this.value)" inputmode="numeric">
        ${lh?.r?`<span class="set-hint">${lh.r}</span>`:''}
      </div>
      <div class="set-field">
        <input type="number" class="set-inp" placeholder="0-5" value="${s.rir}"
          onchange="upSet(${ei},${si},'rir',this.value)" inputmode="numeric" min="0" max="5">
      </div>
      <button class="set-check-btn ${s.done?'done':''}" onclick="toggleDone(${ei},${si},${ex.rest})">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
      </button>
    </div>`;
  }).join('')}

  <label class="partial-row">
    <input type="checkbox" ${ex.partial?'checked':''} onchange="upPartial(${ei},this.checked)">
    + Parciales en estiramiento al fallo
  </label>
  <button class="add-set-btn" onclick="addSet(${ei})">+ Agregar serie</button>
</div>`;
  });

  html += `<div class="finish-zone">
    <button class="btn btn-primary btn-full" onclick="finishWorkout()">üèÅ TERMINAR ENTRENAMIENTO</button>
    <button class="btn btn-danger btn-full btn-sm" style="margin-top:10px" onclick="if(confirm('¬øCancelar sin guardar?')){activeW=null;clearInterval(elapsedIval);skipTimer();go('home')}">Cancelar</button>
  </div>`;

  el.innerHTML = html;
  startElapsed();
}

function upSet(ei,si,f,v) { if(activeW) activeW.exercises[ei].sets[si][f]=v; }
function upPartial(ei,v) { if(activeW) activeW.exercises[ei].partial=v; }

function toggleDone(ei,si,restSecs) {
  if(!activeW) return;
  const s = activeW.exercises[ei].sets[si];
  s.done = !s.done;
  const btn = document.querySelector(`#sr-${ei}-${si} .set-check-btn`);
  const row = document.getElementById(`sr-${ei}-${si}`);
  if(btn) btn.classList.toggle('done', s.done);
  if(row) row.classList.toggle('done-set', s.done);
  if(s.done) startRest(restSecs); else stopRest();
  // update progress
  const tot = activeW.exercises.reduce((a,e)=>a+e.sets.length,0);
  const done = activeW.exercises.reduce((a,e)=>a+e.sets.filter(x=>x.done).length,0);
  const fill = document.getElementById('prog-fill');
  if(fill) fill.style.width = `${Math.round(done/tot*100)}%`;
}

function addSet(ei) {
  if(!activeW) return;
  const ex = activeW.exercises[ei];
  ex.sets.push({i:ex.sets.length+1,w:'',r:'',rir:'',done:false});
  renderWorkout();
  setTimeout(()=>{
    const b = document.getElementById(`exb-${ei}`);
    if(b) b.scrollIntoView({behavior:'smooth',block:'start'});
  },50);
}

function startElapsed() {
  clearInterval(elapsedIval);
  elapsedIval = setInterval(()=>{
    const el = document.getElementById('w-elapsed');
    if(!el||!activeW) return;
    const s = Math.floor((Date.now()-activeW.start)/1000);
    el.textContent = fmtDur(s*1000);
  },1000);
}

// ================================================================
// REST TIMER
// ================================================================
function startRest(secs) {
  stopRest();
  timerSecs = secs;
  const rt = document.getElementById('rest-timer');
  rt.classList.remove('hidden');
  updateRestDisplay();
  timerIval = setInterval(()=>{
    timerSecs--;
    updateRestDisplay();
    if(timerSecs<=0) stopRest();
  },1000);
}
function updateRestDisplay() {
  const d = document.getElementById('rest-display');
  if(!d) return;
  d.textContent = fmtTimer(timerSecs);
  d.classList.toggle('urgent', timerSecs<=10);
}
function stopRest() {
  clearInterval(timerIval);
  document.getElementById('rest-timer').classList.add('hidden');
}
function adjTimer(d) { timerSecs = Math.max(0,timerSecs+d); updateRestDisplay(); }
function skipTimer() { stopRest(); }

// ================================================================
// FINISH WORKOUT
// ================================================================
async function finishWorkout() {
  if(!activeW) return;
  const dur = Date.now()-activeW.start;
  let vol=0, sc=0;
  for (const ex of activeW.exercises) {
    const done = ex.sets.filter(s=>s.done&&s.w&&s.r);
    if(!done.length) continue;
    done.forEach(s=>{ vol+=(parseFloat(s.w)||0)*(parseInt(s.r)||0); sc++; });
    await push('ex_'+ex.id, { date:new Date().toISOString(), sets:done.map(s=>({w:s.w,r:s.r,rir:s.rir})), partial:ex.partial });
  }
  const session = { date:new Date().toISOString(), rn:activeW.rn, dow:activeW.dow, dur, vol, sc };
  await push('sessions', session);
  clearInterval(elapsedIval);
  stopRest();
  showCel(session);
  activeW = null;
}

function showCel(s) {
  document.getElementById('cel-gif').src = CAT_GIFS[Math.floor(Math.random()*CAT_GIFS.length)];
  document.getElementById('cel-stats').innerHTML = `
    <div class="cel-stat"><span class="cel-stat-val">${fmtDur(s.dur)}</span><span class="cel-stat-lbl">Tiempo</span></div>
    <div class="cel-stat"><span class="cel-stat-val">${s.sc}</span><span class="cel-stat-lbl">Series</span></div>
    <div class="cel-stat"><span class="cel-stat-val">${Math.round((s.vol||0)/100)/10}k</span><span class="cel-stat-lbl">kg vol.</span></div>`;
  document.getElementById('celebration').classList.add('show');
}
function closeCel() {
  document.getElementById('celebration').classList.remove('show');
  go('home');
}

// ================================================================
// PROGRESS
// ================================================================
async function renderProgress() {
  const el = document.getElementById('v-progress');
  el.innerHTML = `
<div class="section-head"><div><div class="section-title display">PROGRESO</div><div class="section-sub">Tu evoluci√≥n a lo largo del tiempo</div></div></div>
<div class="tab-row">
  <button class="tab ${progTab==='charts'?'on':''}" onclick="setProgTab('charts')">Gr√°ficas</button>
  <button class="tab ${progTab==='history'?'on':''}" onclick="setProgTab('history')">Historial</button>
  <button class="tab ${progTab==='prs'?'on':''}" onclick="setProgTab('prs')">R√©cords</button>
</div>
<div id="prog-content"></div>`;
  renderProgContent();
}
async function setProgTab(t) {
  progTab=t;
  document.querySelectorAll('#v-progress .tab').forEach((b,i)=>b.classList.toggle('on',['charts','history','prs'][i]===t));
  renderProgContent();
}
async function renderProgContent() {
  const el = document.getElementById('prog-content');
  if(!el) return;
  const sessions = await get('sessions')||[];

  if(progTab==='history') {
    if(!sessions.length) { el.innerHTML = emptyState('üìã','SIN HISTORIAL','Completa tu primer entrenamiento para ver el historial.'); return; }
    el.innerHTML = sessions.slice().reverse().map(s=>`
    <div class="history-row">
      <div class="history-row-date">${new Date(s.date).toLocaleDateString('es',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
      <div class="history-row-title">${s.rn}</div>
      <div class="history-row-meta">
        <span>‚è± ${fmtDur(s.dur)}</span>
        <span>üì¶ ${Math.round((s.vol||0)/100)/10}k kg</span>
        <span>‚úì ${s.sc} series</span>
      </div>
    </div>`).join('');
    return;
  }

  if(progTab==='prs') {
    let html = '';
    for(const ex of ALL_EX) {
      const h = await getExHist(ex.id);
      if(!h.length) continue;
      const pr = Math.max(...h.flatMap(x=>x.sets?.map(s=>parseFloat(s.w)||0)||[0]));
      if(pr>0) html += `<div class="pr-row">
        <div><div class="pr-badge-crown">üèÜ PR</div><div style="font-weight:600;font-size:13px">${ex.name}</div><div style="font-size:11px;color:var(--text2)">${h.length} sesiones</div></div>
        <div class="pr-weight">${pr}<span style="font-size:13px;color:var(--text2)">kg</span></div>
      </div>`;
    }
    el.innerHTML = html || emptyState('üèÜ','A√öN SIN R√âCORDS','Completa al menos una sesi√≥n para ver tus r√©cords.');
    return;
  }

  // Charts
  const keyEx = [
    {id:'e8',name:'Press Banca'},
    {id:'e4',name:'Remo Barra'},
    {id:'e14',name:'Sentadilla'},
    {id:'e20',name:'Curl Barra W'},
    {id:'e23',name:'Fondos'},
    {id:'e26',name:'Press Hombro'}
  ];
  let html = '';
  for(const k of keyEx) {
    const h = await getExHist(k.id);
    if(h.length>=2) html += `<div class="chart-wrap"><div class="chart-lbl">${k.name}<span style="font-size:11px;color:var(--text3)">${h.length} sesiones</span></div><div class="chart-canvas"><canvas id="ch-${k.id}"></canvas></div></div>`;
  }
  if(sessions.length>=2) html += `<div class="chart-wrap"><div class="chart-lbl">Volumen Total</div><div class="chart-canvas"><canvas id="ch-vol"></canvas></div></div>`;
  if(!html) { el.innerHTML = emptyState('üìà','POCOS DATOS','Completa al menos 2 sesiones del mismo ejercicio para ver la gr√°fica.'); return; }
  el.innerHTML = html;
  await new Promise(r=>setTimeout(r,60));
  const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  for(const k of keyEx) {
    const h = await getExHist(k.id);
    if(h.length<2) continue;
    const c = document.getElementById('ch-'+k.id);
    if(!c) continue;
    if(charts[k.id]) charts[k.id].destroy();
    charts[k.id] = new Chart(c, {
      type:'line',
      data:{
        labels:h.map(x=>new Date(x.date).toLocaleDateString('es',{day:'numeric',month:'short'})),
        datasets:[{data:h.map(x=>Math.max(...(x.sets?.map(s=>parseFloat(s.w)||0)||[0]))),
          borderColor:accent,backgroundColor:accent+'22',borderWidth:2.5,pointBackgroundColor:accent,pointRadius:4,fill:true,tension:0.3}]
      },
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
        scales:{x:{ticks:{color:'#55556A',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(255,255,255,0.05)'}},
               y:{ticks:{color:'#55556A',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(255,255,255,0.05)'}}}}
    });
  }
  if(sessions.length>=2) {
    const c = document.getElementById('ch-vol');
    if(c){
      if(charts.vol) charts.vol.destroy();
      const last20 = sessions.slice(-20);
      charts.vol = new Chart(c,{type:'bar',data:{
        labels:last20.map(s=>new Date(s.date).toLocaleDateString('es',{day:'numeric',month:'short'})),
        datasets:[{data:last20.map(s=>Math.round((s.vol||0)/100)/10),backgroundColor:accent+'88',borderColor:accent,borderWidth:1,borderRadius:4}]
      },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
        scales:{x:{ticks:{color:'#55556A',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(255,255,255,0.05)'}},
               y:{ticks:{color:'#55556A',font:{family:'JetBrains Mono',size:10},callback:v=>v+'k'},grid:{color:'rgba(255,255,255,0.05)'}}}}});
    }
  }
}

// ================================================================
// BODY VIEW
// ================================================================
async function renderBody() {
  const el = document.getElementById('v-body');
  const logs = await get('bodyLogs')||[];
  const last = logs.slice(-1)[0]||{};

  el.innerHTML = `
<div class="section-head"><div><div class="section-title display">CUERPO</div><div class="section-sub">Composici√≥n y medidas</div></div></div>
<div class="card">
  <div style="font-weight:700;font-size:14px;letter-spacing:0.5px;margin-bottom:14px">REGISTRAR HOY</div>
  <div class="body-grid">
    <div class="body-field"><label class="input-label">Peso (kg)</label><input type="number" class="body-inp" id="b-w" placeholder="${last.w||'75.0'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="input-label">M√∫sculo (%)</label><input type="number" class="body-inp" id="b-mp" placeholder="${last.mp||'42.0'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="input-label">Grasa (%)</label><input type="number" class="body-inp" id="b-fp" placeholder="${last.fp||'18.0'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="input-label">M√∫sculo (kg)</label><input type="number" class="body-inp" id="b-mk" placeholder="${last.mk||'30.0'}" step="0.1" inputmode="decimal"></div>
  </div>
  <div style="font-weight:700;font-size:13px;letter-spacing:0.5px;margin:14px 0 10px">MEDIDAS cm</div>
  <div class="body-grid">
    <div class="body-field"><label class="input-label">Brazo Izq.</label><input type="number" class="body-inp" id="b-bi" placeholder="${last.bi||'‚Äî'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="input-label">Brazo Der.</label><input type="number" class="body-inp" id="b-bd" placeholder="${last.bd||'‚Äî'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="input-label">Pecho</label><input type="number" class="body-inp" id="b-pe" placeholder="${last.pe||'‚Äî'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="input-label">Cintura</label><input type="number" class="body-inp" id="b-ci" placeholder="${last.ci||'‚Äî'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="input-label">Pantorrilla Izq.</label><input type="number" class="body-inp" id="b-pi" placeholder="${last.pi||'‚Äî'}" step="0.1" inputmode="decimal"></div>
    <div class="body-field"><label class="input-label">Pantorrilla Der.</label><input type="number" class="body-inp" id="b-pd" placeholder="${last.pd||'‚Äî'}" step="0.1" inputmode="decimal"></div>
  </div>
  <input class="input" id="b-notes" placeholder="Notas (ej: en ayunas, post-entreno...)" style="margin-top:10px;margin-bottom:14px">
  <button class="btn btn-primary btn-full" onclick="saveBody()">GUARDAR MEDICI√ìN</button>
</div>

${logs.length>=2 ? `
<div class="chart-wrap" style="margin-top:10px">
  <div class="chart-lbl">Peso corporal</div>
  <div class="chart-canvas"><canvas id="ch-body-w"></canvas></div>
</div>
<div class="chart-wrap">
  <div class="chart-lbl">M√∫sculo % / Grasa %</div>
  <div class="chart-canvas"><canvas id="ch-body-m"></canvas></div>
</div>` : ''}

<div class="card" style="margin-top:10px">
  <div style="font-weight:700;font-size:14px;margin-bottom:12px">HISTORIAL MEDICIONES</div>
  ${logs.length===0?'<div style="text-align:center;color:var(--text3);padding:20px">Sin registros a√∫n</div>' :
    logs.slice().reverse().slice(0,15).map((log,i,arr)=>{
      const prev = arr[i+1];
      const dw = prev&&log.w&&prev.w ? (parseFloat(log.w)-parseFloat(prev.w)).toFixed(1) : null;
      return `<div class="measure-row">
        <div>
          <div class="measure-lbl">${new Date(log.date).toLocaleDateString('es',{day:'numeric',month:'short',year:'numeric'})}</div>
          ${log.notes?`<div style="font-size:11px;color:var(--text3)">${log.notes}</div>`:''}
        </div>
        <div style="text-align:right">
          ${log.w?`<div class="measure-val">${log.w}kg ${dw!==null?`<span class="${parseFloat(dw)>0?'measure-delta-pos':'measure-delta-neg'}">${parseFloat(dw)>0?'+':''}${dw}</span>`:''}</div>`:''}
          ${log.mp?`<div style="font-family:var(--mono);font-size:12px;color:var(--text2)">${log.mp}% m√∫sculo</div>`:''}
        </div>
      </div>`;
    }).join('')
  }
</div>`;

  if(logs.length>=2) {
    await new Promise(r=>setTimeout(r,60));
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    const labels = logs.map(l=>new Date(l.date).toLocaleDateString('es',{day:'numeric',month:'short'}));
    const cw = document.getElementById('ch-body-w');
    if(cw){
      if(charts.bw) charts.bw.destroy();
      charts.bw = new Chart(cw,{type:'line',data:{labels,datasets:[{data:logs.map(l=>parseFloat(l.w)||null),borderColor:accent,backgroundColor:accent+'22',borderWidth:2,fill:true,tension:0.3,pointRadius:3}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#55556A',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(255,255,255,0.05)'}},y:{ticks:{color:'#55556A',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(255,255,255,0.05)'}}}}});
    }
    const cm = document.getElementById('ch-body-m');
    if(cm){
      if(charts.bm) charts.bm.destroy();
      charts.bm = new Chart(cm,{type:'line',data:{labels,datasets:[
        {label:'M√∫sculo%',data:logs.map(l=>parseFloat(l.mp)||null),borderColor:'#AA44FF',backgroundColor:'rgba(170,68,255,0.1)',borderWidth:2,fill:false,tension:0.3,pointRadius:3},
        {label:'Grasa%',data:logs.map(l=>parseFloat(l.fp)||null),borderColor:'#FF4466',backgroundColor:'rgba(255,68,102,0.1)',borderWidth:2,fill:false,tension:0.3,pointRadius:3}
      ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,labels:{color:'#8888A8',font:{family:'JetBrains Mono',size:10}}}},
        scales:{x:{ticks:{color:'#55556A',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(255,255,255,0.05)'}},y:{ticks:{color:'#55556A',font:{family:'JetBrains Mono',size:10},callback:v=>v+'%'},grid:{color:'rgba(255,255,255,0.05)'}}}}});
    }
  }
}
async function saveBody() {
  const vals = {};
  ['w','mp','fp','mk','bi','bd','pe','ci','pi','pd'].forEach(k=>{
    const v = document.getElementById('b-'+k)?.value; if(v) vals[k]=v;
  });
  const notes = document.getElementById('b-notes')?.value;
  if(!Object.keys(vals).length) { toast('Ingresa al menos un valor'); return; }
  await push('bodyLogs', { date:new Date().toISOString(), ...vals, notes });
  toast('‚úÖ Medici√≥n guardada');
  renderBody();
}

// ================================================================
// SETTINGS
// ================================================================
async function renderSettings() {
  const el = document.getElementById('v-settings');
  const sessions = await get('sessions')||[];
  const bodyLogs = await get('bodyLogs')||[];
  const curAccent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();

  el.innerHTML = `
<div class="section-head"><div><div class="section-title display">AJUSTES</div></div></div>

<!-- SYNC STATUS -->
<div class="sync-indicator">
  <div class="sync-dot ${useFB&&db?'live':'local'}"></div>
  <span style="color:var(--text2)">${useFB&&db?'‚òÅ Firebase activo ‚Äî datos en la nube':'üíæ Modo local ‚Äî solo este dispositivo'}</span>
</div>

<!-- USER CODE -->
<div class="card" style="margin-bottom:16px">
  <div style="font-weight:700;font-size:13px;letter-spacing:0.5px;margin-bottom:6px">TU C√ìDIGO DE ACCESO</div>
  <div style="font-size:12px;color:var(--text2);margin-bottom:8px">Ingresa este c√≥digo en cualquier dispositivo para acceder a tus datos</div>
  <div class="user-code">${userId||'‚Äî'}</div>
  <button class="btn btn-ghost btn-full btn-sm" onclick="navigator.clipboard.writeText('${userId||''}');toast('Copiado ‚úì')">Copiar c√≥digo</button>
</div>

<!-- ACENTO / COLORES -->
<div class="card" style="margin-bottom:10px">
  <div style="font-weight:700;font-size:13px;letter-spacing:0.5px;margin-bottom:10px">COLOR DE LA APP</div>
  <div class="color-swatches" id="swatches">
    ${ACCENT_COLORS.map(c=>`
    <div class="swatch ${c.v===curAccent?'active':''}" style="background:${c.v}" onclick="setAccent('${c.v}','${c.rgb}')" title="${c.name}"></div>`).join('')}
    <input type="color" id="custom-color" value="${curAccent}" title="Color personalizado"
      style="width:36px;height:36px;border-radius:50%;border:2px solid var(--border2);cursor:pointer;padding:2px;background:var(--bg4)"
      oninput="setAccentCustom(this.value)">
  </div>
</div>

<!-- ROUTINE EDIT -->
<div class="settings-row" onclick="openRoutineEditor()">
  <div class="settings-row-left">
    <div class="settings-row">
      <div><h4>‚úèÔ∏è Editar Rutina</h4><p>Personaliza series, repeticiones o a√±ade ejercicios</p></div>
      <div class="settings-row-icon">‚Üí</div>
    </div>
  </div>
</div>

<!-- Firebase connect -->
${!useFB||!db ? `
<div class="card" style="margin-bottom:10px">
  <div style="font-weight:700;font-size:13px;margin-bottom:12px">CONECTAR FIREBASE (CLOUD SYNC)</div>
  <input class="input" id="s-key" placeholder="apiKey" style="margin-bottom:8px">
  <input class="input" id="s-pid" placeholder="projectId" style="margin-bottom:8px">
  <input class="input" id="s-aid" placeholder="appId" style="margin-bottom:12px">
  <button class="btn btn-primary btn-full btn-sm" onclick="connectFBSettings()">Conectar</button>
</div>` : ''}

<!-- EXPORT/IMPORT -->
<div class="settings-row" onclick="exportData()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:15px 16px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;cursor:pointer">
  <div><h4 style="font-size:15px;font-weight:600;margin-bottom:2px">üì§ Exportar datos</h4><p style="font-size:12px;color:var(--text2)">${sessions.length} sesiones ¬∑ ${bodyLogs.length} mediciones</p></div>
  <span style="color:var(--text3);font-size:18px">‚Üí</span>
</div>
<div onclick="importData()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:15px 16px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;cursor:pointer">
  <div><h4 style="font-size:15px;font-weight:600;margin-bottom:2px">üì• Importar datos</h4><p style="font-size:12px;color:var(--text2)">Cargar backup JSON</p></div>
  <span style="color:var(--text3);font-size:18px">‚Üí</span>
</div>
<div onclick="if(confirm('¬øBorrar TODO? Irreversible.'))clearAll()" style="background:rgba(255,68,102,0.05);border:1px solid rgba(255,68,102,0.2);border-radius:var(--r);padding:15px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer">
  <div><h4 style="font-size:15px;font-weight:600;color:var(--red)">üóë Borrar todo</h4><p style="font-size:12px;color:var(--red);opacity:0.7">Acci√≥n irreversible</p></div>
  <span style="color:var(--red);font-size:18px">‚Üí</span>
</div>

<div class="card" style="text-align:center;padding:28px">
  <div style="font-family:var(--display);font-size:36px;letter-spacing:3px;margin-bottom:4px">HYPER<span style="color:var(--accent)">.</span></div>
  <div style="font-size:12px;color:var(--text3);letter-spacing:1px">LAB DE HIPERTROFIA ¬∑ JAIME<br>Datos tuyos, para siempre.</div>
</div>`;
}

async function setAccent(v, rgb) {
  applyAccent(v, rgb);
  await set('accent', {v,rgb});
  renderSettings();
}
async function setAccentCustom(v) {
  const r = parseInt(v.slice(1,3),16), g2 = parseInt(v.slice(3,5),16), b = parseInt(v.slice(5,7),16);
  const rgb = `${r},${g2},${b}`;
  applyAccent(v, rgb);
  await set('accent', {v,rgb});
}
function applyAccent(v, rgb) {
  document.documentElement.style.setProperty('--accent', v);
  document.documentElement.style.setProperty('--accent-rgb', rgb);
}

function connectFBSettings() {
  const key = document.getElementById('s-key').value.trim();
  const pid = document.getElementById('s-pid').value.trim();
  const aid = document.getElementById('s-aid').value.trim();
  if(!key||!pid||!aid){ toast('Completa todos los campos'); return; }
  const fbCfg = { apiKey:key, projectId:pid, appId:aid, authDomain:`${pid}.firebaseapp.com`, storageBucket:`${pid}.appspot.com` };
  try {
    if(!firebase.apps.length) firebase.initializeApp(fbCfg);
    else firebase.app();
    db = firebase.firestore();
    useFB = true;
    localStorage.setItem('ht2_cfg', JSON.stringify({userId,useFB:true,fbCfg}));
    toast('‚òÅ Firebase conectado!');
    renderSettings();
  } catch(e) { toast('Error: '+e.message); }
}

async function openRoutineEditor() {
  // Simple routine editor ‚Äî shows per-day exercise list with editable sets/reps
  const sheets = `<div class="overlay open" id="routine-overlay" onclick="if(event.target===this)this.remove()">
    <div class="sheet">
      <div class="sheet-handle"></div>
      <div class="sheet-title">EDITAR RUTINA</div>
      ${Object.entries(DAYS).filter(([,d])=>!d.rest).map(([dow,d])=>`
      <div style="margin-bottom:20px">
        <div style="font-family:var(--display);font-size:18px;letter-spacing:1px;margin-bottom:10px;color:var(--text2)">${d.emoji} ${d.name}</div>
        ${d.exercises.map(ex=>`
        <div class="ex-edit-card">
          <div class="ex-edit-name">${ex.name}</div>
          <div class="ex-edit-meta">
            <span style="font-size:12px;color:var(--text2)">Series:</span>
            <input type="number" class="ex-edit-inp" value="${ex.sets}" id="edit-${ex.id}-s" min="1" max="8" inputmode="numeric">
            <span style="font-size:12px;color:var(--text2)">Reps:</span>
            <input type="number" class="ex-edit-inp" value="${ex.rMin}" id="edit-${ex.id}-rmin" min="1" inputmode="numeric">
            <span style="font-size:11px;color:var(--text3)">‚Äî</span>
            <input type="number" class="ex-edit-inp" value="${ex.rMax}" id="edit-${ex.id}-rmax" min="1" inputmode="numeric">
          </div>
        </div>`).join('')}
      </div>`).join('')}
      <button class="btn btn-primary btn-full" onclick="saveRoutineEdits()">GUARDAR CAMBIOS</button>
    </div>
  </div>`;
  document.body.insertAdjacentHTML('beforeend', sheets);
}

function saveRoutineEdits() {
  ALL_EX.forEach(ex=>{
    const s = document.getElementById('edit-'+ex.id+'-s');
    const rmin = document.getElementById('edit-'+ex.id+'-rmin');
    const rmax = document.getElementById('edit-'+ex.id+'-rmax');
    if(s&&parseInt(s.value)>0) ex.sets = parseInt(s.value);
    if(rmin&&parseInt(rmin.value)>0) ex.rMin = parseInt(rmin.value);
    if(rmax&&parseInt(rmax.value)>0) ex.rMax = parseInt(rmax.value);
  });
  document.getElementById('routine-overlay')?.remove();
  toast('‚úÖ Rutina actualizada');
}

// ================================================================
// EXPORT / IMPORT
// ================================================================
async function exportData() {
  const sessions = await get('sessions')||[];
  const bodyLogs = await get('bodyLogs')||[];
  const exercises = {};
  for(const ex of ALL_EX) {
    const h = await getExHist(ex.id);
    if(h.length) exercises[ex.id] = {name:ex.name, history:h};
  }
  const data = { exportDate:new Date().toISOString(), userId, sessions, bodyLogs, exercises };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `hyper-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  toast('üì§ Backup exportado');
}
function importData() {
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='.json';
  inp.onchange = async e => {
    const txt = await e.target.files[0].text();
    try {
      const d = JSON.parse(txt);
      if(d.sessions) await set('sessions',d.sessions);
      if(d.bodyLogs) await set('bodyLogs',d.bodyLogs);
      if(d.exercises) for(const[id,ex] of Object.entries(d.exercises)) await set('ex_'+id,ex.history);
      toast('üì• Datos importados');
      renderSettings();
    } catch(err) { toast('Error: '+err.message); }
  };
  inp.click();
}
async function clearAll() {
  Object.keys(localStorage).filter(k=>k.startsWith('ht2_')&&k!=='ht2_cfg').forEach(k=>localStorage.removeItem(k));
  if(useFB&&db&&userId) {
    try { const col = await db.collection('users').doc(userId).collection('data').get(); col.forEach(d=>d.ref.delete()); } catch(e){}
  }
  toast('üóë Datos eliminados');
  renderSettings();
}

// ================================================================
// UTILS
// ================================================================
function fmtDur(ms) {
  const s = Math.floor(ms/1000);
  const m = Math.floor(s/60), h = Math.floor(m/60);
  if(h>0) return `${h}h ${m%60}m`;
  return `${m}m ${s%60}s`;
}
function fmtTimer(s) { return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}
function emptyState(icon,title,desc) {
  return `<div class="empty"><div class="empty-icon">${icon}</div><h3>${title}</h3><p>${desc}</p></div>`;
}
</script>
</body>
</html>
